<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Dihlickvery ‚Äì Wall Street Hustle</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&family=VT323&display=swap');
:root{--bg:#0d0d1a;--panel:#13132b;--border:#f7c948;--accent:#f7c948;--red:#e8334a;--blue:#3a9bd5;--green:#3ddc84;--white:#f0f0f0;--shadow:#f7c94866;--px:4px;}
*{box-sizing:border-box;margin:0;padding:0;}
body{background:var(--bg);font-family:'Press Start 2P',monospace;min-height:100vh;overflow:hidden;position:relative;}
body::after{content:'';position:fixed;inset:0;pointer-events:none;z-index:9999;background:repeating-linear-gradient(to bottom,transparent 0,transparent 3px,rgba(0,0,0,.15) 3px,rgba(0,0,0,.15) 4px);}
.screen{display:none;position:absolute;inset:0;}.screen.active{display:flex;}
#stars{position:fixed;inset:0;pointer-events:none;z-index:0;}
.star{position:absolute;background:var(--white);animation:twinkle var(--d,2s) infinite alternate;}
@keyframes twinkle{from{opacity:.1}to{opacity:.9}}
.skyline{position:fixed;bottom:0;left:0;right:0;height:160px;z-index:1;pointer-events:none;}.skyline svg{width:100%;height:100%;}
.float-item{position:fixed;font-size:26px;pointer-events:none;z-index:2;animation:floatUp var(--d) linear infinite;opacity:0;}
@keyframes floatUp{0%{transform:translateY(0) rotate(0);opacity:0}10%{opacity:.6}90%{opacity:.4}100%{transform:translateY(-100vh) rotate(360deg);opacity:0}}
#menuScreen{align-items:center;justify-content:center;flex-direction:column;z-index:10;}
.title-card{position:relative;background:var(--panel);border:var(--px) solid var(--border);box-shadow:8px 8px 0 #000,0 0 40px var(--shadow);padding:32px 48px 24px;text-align:center;min-width:520px;}
.title-card::before,.title-card::after{content:'';position:absolute;width:16px;height:16px;background:var(--border);top:-4px;}.title-card::before{left:-4px}.title-card::after{right:-4px}
.game-title{font-size:30px;color:var(--accent);letter-spacing:2px;line-height:1.3;text-shadow:4px 4px 0 var(--red),8px 8px 0 #000,0 0 20px var(--shadow);animation:titlePulse 3s ease-in-out infinite;}
@keyframes titlePulse{0%,100%{text-shadow:4px 4px 0 var(--red),8px 8px 0 #000,0 0 20px var(--shadow)}50%{text-shadow:4px 4px 0 var(--red),8px 8px 0 #000,0 0 40px #f7c94899}}
.subtitle{font-family:'VT323',monospace;font-size:18px;color:var(--blue);margin-top:8px;letter-spacing:3px;animation:blink 1.2s steps(1) infinite;}
@keyframes blink{0%,49%{opacity:1}50%,100%{opacity:0}}
.pixel-divider{width:100%;height:4px;margin:18px 0 0;background:repeating-linear-gradient(to right,var(--border) 0,var(--border) 8px,transparent 8px,transparent 16px);}
.buttons-panel{background:var(--panel);border:var(--px) solid var(--border);border-top:none;box-shadow:8px 8px 0 #000;padding:28px 48px 32px;display:flex;flex-direction:column;gap:14px;width:100%;align-items:center;position:relative;}
.buttons-panel::before,.buttons-panel::after{content:'';position:absolute;width:16px;height:16px;background:var(--border);bottom:-4px;}.buttons-panel::before{left:-4px}.buttons-panel::after{right:-4px}
.px-btn{font-family:'Press Start 2P',monospace;font-size:13px;letter-spacing:1px;cursor:pointer;border:none;outline:none;padding:14px 0;width:300px;text-align:center;position:relative;transition:transform .05s,box-shadow .05s;user-select:none;}
.px-btn:active{transform:translate(4px,4px)!important;box-shadow:none!important;}
.btn-play{background:var(--red);color:#fff;box-shadow:4px 4px 0 #7a0f1f,8px 8px 0 #000;border:var(--px) solid #ff6b7a;border-bottom-color:#7a0f1f;border-right-color:#7a0f1f;animation:playGlow 2s ease-in-out infinite;}
.btn-play:hover{background:#ff4d63;transform:translate(-2px,-2px);}
@keyframes playGlow{0%,100%{box-shadow:4px 4px 0 #7a0f1f,8px 8px 0 #000}50%{box-shadow:4px 4px 0 #7a0f1f,8px 8px 0 #000,0 0 18px #e8334a88}}
.btn-tutorial{background:#1a2a1a;color:var(--green);box-shadow:4px 4px 0 #003310,8px 8px 0 #000;border:var(--px) solid #3ddc84;border-bottom-color:#003310;border-right-color:#003310;}
.btn-tutorial:hover{background:#1e3a1e;transform:translate(-2px,-2px);}
.btn-credits{background:var(--blue);color:#fff;box-shadow:4px 4px 0 #1b567a,8px 8px 0 #000;border:var(--px) solid #7cd4ff;border-bottom-color:#1b567a;border-right-color:#1b567a;}
.btn-credits:hover{background:#5bb8f5;transform:translate(-2px,-2px);}
.btn-sandbox{background:#333355;color:#888899;box-shadow:4px 4px 0 #111122,8px 8px 0 #000;border:var(--px) solid #555577;border-bottom-color:#111122;border-right-color:#111122;cursor:not-allowed;}
.btn-sandbox::after{content:'COMING SOON';position:absolute;top:-10px;right:-10px;background:var(--accent);color:#000;font-size:7px;padding:3px 5px;border:2px solid #000;white-space:nowrap;box-shadow:2px 2px 0 #000;}
.version{font-family:'VT323',monospace;font-size:14px;color:#444466;margin-top:10px;letter-spacing:2px;}
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:1000;align-items:center;justify-content:center;}.modal-overlay.active{display:flex;}
.modal-box{background:var(--panel);border:var(--px) solid var(--border);box-shadow:8px 8px 0 #000,0 0 40px var(--shadow);padding:36px 48px;max-width:480px;width:90%;text-align:center;position:relative;}
.modal-box h2{font-size:16px;color:var(--accent);margin-bottom:20px;text-shadow:3px 3px 0 var(--red);}
.modal-box p{font-family:'VT323',monospace;font-size:20px;color:var(--white);line-height:1.7;margin-bottom:4px;}.modal-box .role{color:var(--blue);font-size:18px;}
.modal-close{margin-top:24px;font-family:'Press Start 2P',monospace;font-size:11px;background:var(--red);color:#fff;border:var(--px) solid #ff6b7a;border-bottom-color:#7a0f1f;border-right-color:#7a0f1f;box-shadow:4px 4px 0 #000;padding:12px 28px;cursor:pointer;}.modal-close:hover{background:#ff4d63;}
.honor-btn{position:absolute;bottom:10px;right:12px;font-family:'Press Start 2P',monospace;font-size:6px;color:#444466;background:transparent;border:1px solid #333355;padding:4px 6px;cursor:pointer;transition:color .15s,border-color .15s;}.honor-btn:hover{color:#8888aa;border-color:#8888aa;}
.honor-bubble{display:none;position:absolute;bottom:34px;right:12px;background:#1e1e3a;border:2px solid var(--accent);box-shadow:3px 3px 0 #000;padding:8px 12px;font-family:'VT323',monospace;font-size:20px;color:var(--accent);white-space:nowrap;z-index:10;}
.honor-bubble::after{content:'';position:absolute;bottom:-8px;right:16px;width:0;height:0;border-left:6px solid transparent;border-right:6px solid transparent;border-top:8px solid var(--accent);}.honor-bubble.show{display:block;}
#gameScreen{flex-direction:column;z-index:10;background:var(--bg);}
#tutorialBadge{display:none;position:absolute;top:8px;right:14px;font-family:'Press Start 2P',monospace;font-size:7px;color:#000;background:var(--green);border:2px solid #1eff88;border-bottom-color:#007733;border-right-color:#007733;box-shadow:2px 2px 0 #000;padding:4px 8px;z-index:25;pointer-events:none;animation:tutBadgePulse 2s ease-in-out infinite;}
@keyframes tutBadgePulse{0%,100%{box-shadow:2px 2px 0 #000}50%{box-shadow:2px 2px 0 #000,0 0 10px #3ddc8488}}
#tutorialBadge.show{display:block;}
.hud{display:flex;align-items:center;justify-content:space-between;background:#0a0a16;border-bottom:3px solid var(--border);padding:10px 18px;gap:10px;flex-shrink:0;position:relative;z-index:20;}
.hud-block{display:flex;flex-direction:column;align-items:center;gap:4px;}.hud-label{font-size:6px;color:#888;letter-spacing:1px;}.hud-value{font-size:13px;color:var(--accent);}.hud-value.green{color:var(--green);}.hud-value.red{color:var(--red);}
.timer-bar-bg{width:180px;height:12px;background:#1a1a30;border:2px solid #333;}.timer-bar-fill{height:100%;background:var(--green);transition:width .1s linear;box-shadow:0 0 8px var(--green);}
.round-pips{display:flex;gap:5px;}.pip{width:11px;height:11px;border:2px solid #444;background:#1a1a30;}.pip.done{background:var(--accent);border-color:var(--accent);box-shadow:0 0 5px var(--accent);}.pip.active{background:var(--red);border-color:var(--red);animation:pipPulse .6s steps(2) infinite;}
@keyframes pipPulse{0%{opacity:1}100%{opacity:.4}}
.game-body{display:flex;flex:1;overflow:hidden;}
.shop-panel{width:190px;background:#0e0e20;border-right:3px solid #1e1e3a;display:flex;flex-direction:column;padding:10px;gap:5px;overflow-y:auto;flex-shrink:0;}
.shop-title{font-size:8px;color:var(--accent);text-align:center;margin-bottom:4px;border-bottom:2px solid #1e1e3a;padding-bottom:6px;}
.shop-item{background:#13132b;border:2px solid #2a2a4e;padding:7px;cursor:pointer;user-select:none;transition:border-color .1s;}.shop-item:hover{border-color:var(--accent);}
.shop-item.quick-buy{border-color:var(--green);cursor:pointer;}
.shop-item-icon{font-size:20px;display:block;text-align:center;margin-bottom:3px;}.shop-item-name{font-size:6px;color:var(--white);text-align:center;display:block;margin-bottom:3px;}.shop-item-price{font-size:7px;color:var(--green);text-align:center;display:block;}
.buy-btn{font-family:'Press Start 2P',monospace;font-size:6px;background:#1e1e3a;color:var(--accent);border:2px solid #333;padding:4px;cursor:pointer;width:100%;margin-top:4px;}.buy-btn:hover{background:#2a2a50;border-color:var(--accent);}.buy-btn.hidden{display:none;}
.inventory-section{margin-top:6px;border-top:2px dashed #1e1e3a;padding-top:6px;}.inv-title{font-size:6px;color:#888;margin-bottom:5px;}
.inv-slot{display:flex;align-items:center;gap:5px;background:#0a0a16;border:2px solid #1a1a2e;padding:4px;margin-bottom:3px;cursor:grab;}.inv-slot:hover{border-color:var(--blue);}
.inv-slot-icon{font-size:15px;}.inv-slot-name{font-size:6px;color:var(--white);display:block;}.inv-slot-qty{font-size:6px;color:var(--green);}
.inv-empty{font-family:'VT323',monospace;font-size:14px;color:#333;text-align:center;padding:6px;}
.combo-tray{margin-top:6px;border-top:2px dashed #3a2a1e;padding-top:6px;display:none;}.combo-tray.show{display:block;}
.combo-title{font-size:6px;color:var(--accent);margin-bottom:4px;}
.combo-staging{display:flex;gap:3px;flex-wrap:wrap;margin-bottom:4px;}
.combo-slot{width:30px;height:30px;border:2px dashed #3a2a1e;background:#0a0a16;display:flex;align-items:center;justify-content:center;font-size:16px;cursor:pointer;}.combo-slot.filled{border-color:var(--accent);border-style:solid;}
.combo-make-btn{font-family:'Press Start 2P',monospace;font-size:6px;background:#0a1a0a;color:var(--green);border:2px solid var(--green);padding:3px 5px;cursor:pointer;width:100%;margin-top:4px;margin-bottom:5px;}
.combo-make-btn:disabled{opacity:.35;cursor:not-allowed;}
.combo-clear{font-family:'Press Start 2P',monospace;font-size:6px;background:#1a0a0a;color:var(--red);border:1px solid var(--red);padding:3px 5px;cursor:pointer;margin-top:2px;width:100%;}
.set-boxes{display:flex;flex-direction:column;gap:4px;margin-top:4px;}
.set-box{background:#0a1a0a;border:2px solid var(--green);padding:5px 6px;cursor:grab;display:flex;align-items:center;gap:4px;box-shadow:0 0 6px #3ddc8444;position:relative;}
.set-box:hover{border-color:#5fffaa;box-shadow:0 0 10px #3ddc8477;}
.set-box-label{font-family:'VT323',monospace;font-size:15px;color:var(--green);flex:1;line-height:1;}
.set-box-discard{font-size:9px;color:var(--red);cursor:pointer;padding:1px 3px;border:1px solid var(--red);line-height:1;background:transparent;}
.set-box-discard:hover{background:#2a0a0a;}
.map-area{flex:1;position:relative;overflow:hidden;background:#080814;}.map-canvas{position:absolute;inset:0;}
.building{position:absolute;cursor:default;user-select:none;}.building-label{position:absolute;bottom:-22px;left:50%;transform:translateX(-50%);font-family:'VT323',monospace;font-size:12px;color:#777;white-space:nowrap;text-align:center;}
.order-bubble{position:absolute;background:#0d0d20;border:2px solid var(--accent);box-shadow:3px 3px 0 #000,0 0 10px var(--shadow);padding:4px 8px;font-family:'VT323',monospace;font-size:15px;color:var(--white);white-space:nowrap;pointer-events:none;z-index:30;transform:translateX(-50%);animation:bubblePop .2s steps(3) forwards;}
.order-bubble::after{content:'';position:absolute;bottom:-8px;left:50%;transform:translateX(-50%);width:0;height:0;border-left:5px solid transparent;border-right:5px solid transparent;border-top:8px solid var(--accent);}
@keyframes bubblePop{from{transform:translateX(-50%) scale(0)}to{transform:translateX(-50%) scale(1)}}
.order-timer-bar{width:100%;height:3px;background:#1a1a30;margin-top:3px;}.order-timer-fill{height:100%;background:var(--green);transition:width .1s linear;}
.building.drop-target .bsvg{filter:brightness(1.8) drop-shadow(0 0 12px #3ddc84);}
.building.impatient .bsvg{animation:impatientFlash .3s steps(2) infinite;}
@keyframes impatientFlash{0%{filter:brightness(1)}100%{filter:brightness(1.6) hue-rotate(180deg)}}
#mapRider{position:absolute;font-size:26px;z-index:40;pointer-events:none;transition:left .45s ease,top .45s ease;animation:riderBob .35s steps(2) infinite;}
@keyframes riderBob{0%,100%{transform:translateY(0)}50%{transform:translateY(-3px)}}
#dragGhost{position:fixed;pointer-events:none;z-index:9998;font-size:28px;display:none;transform:translate(-50%,-50%);}
.market-panel{width:170px;background:#0e0e20;border-left:3px solid #1e1e3a;display:flex;flex-direction:column;padding:10px;gap:5px;overflow-y:auto;flex-shrink:0;}
.market-title{font-size:8px;color:var(--accent);text-align:center;margin-bottom:4px;border-bottom:2px solid #1e1e3a;padding-bottom:6px;}
.market-row{background:#13132b;border:2px solid #1e1e3a;padding:6px 7px;}.market-row-name{font-size:6px;color:#aaa;margin-bottom:3px;}.market-row-price{font-size:10px;color:var(--green);}
.market-row-price.up::after{content:' \u25b2';color:var(--green);font-size:7px;}.market-row-price.down::after{content:' \u25bc';color:var(--red);font-size:7px;}
.market-event-box{background:#150808;border:2px solid var(--red);padding:7px;margin-top:6px;}.market-event-title{font-size:6px;color:var(--red);margin-bottom:4px;}.market-event-text{font-family:'VT323',monospace;font-size:13px;color:#ff7777;line-height:1.4;}
.power-panel{border-top:2px solid #1e1e3a;padding-top:6px;margin-top:4px;}.power-title{font-size:6px;color:#cc88ff;margin-bottom:4px;}
.power-btn{font-family:'Press Start 2P',monospace;font-size:6px;background:#140820;color:#cc88ff;border:2px solid #4a2a6a;padding:4px 5px;cursor:pointer;width:100%;margin-bottom:3px;text-align:left;line-height:1.4;transition:border-color .1s;}
.power-btn:hover:not(:disabled){border-color:#cc88ff;background:#1e1030;}.power-btn:disabled{opacity:.4;cursor:not-allowed;}
.power-btn.active-power{border-color:var(--green);color:var(--green);background:#0a1a10;}.power-btn .pcost{color:var(--accent);display:block;}.power-btn .pdesc{color:#888;font-size:5px;display:block;margin-top:2px;}
.status-bar{background:#080810;border-top:3px solid #1e1e3a;padding:7px 14px;display:flex;align-items:center;gap:10px;flex-shrink:0;}
.status-msg{font-family:'VT323',monospace;font-size:16px;color:var(--blue);flex:1;}
.capacity-bar{display:flex;gap:3px;}.cap-slot{width:12px;height:12px;border:2px solid #333;background:#0a0a16;}.cap-slot.used{background:var(--blue);border-color:var(--blue);}
/* ‚ïê‚ïê‚ïê TUTORIAL OVERLAY SYSTEM ‚ïê‚ïê‚ïê */
#tutOverlay{display:none;position:fixed;inset:0;z-index:800;pointer-events:none;}
#tutOverlay.active{display:block;}
#tutDark{position:absolute;inset:0;background:rgba(0,0,0,0.62);pointer-events:none;}
.tut-highlight-el{position:relative;z-index:850!important;outline:3px solid var(--red)!important;outline-offset:3px;border-radius:2px;animation:tutHL 1s ease-in-out infinite;pointer-events:all!important;}
.tut-card{position:fixed;bottom:0;left:0;right:0;z-index:860;background:#130008;border-top:3px solid var(--red);padding:14px 24px 14px 20px;display:flex;flex-direction:column;gap:8px;pointer-events:all;box-shadow:0 -4px 24px #ff000033;}
.tut-card-header{display:flex;align-items:center;gap:12px;}
.tut-card-tag{font-family:'Press Start 2P',monospace;font-size:7px;color:var(--red);white-space:nowrap;border:1px solid #660011;padding:3px 6px;background:#1a0005;}
.tut-card-msg{font-family:'VT323',monospace;font-size:19px;color:#fff;line-height:1.35;flex:1;}
.tut-card-msg strong{background:var(--red);color:#fff;padding:1px 5px;}
.tut-card-msg em{background:#600;color:#ffaaaa;padding:1px 4px;font-style:normal;}
.tut-card-action{font-family:'VT323',monospace;font-size:16px;color:var(--accent);padding-left:2px;}
.tut-card-action::before{content:'‚ñ∂ ';}
.tut-card-footer{display:flex;align-items:center;gap:10px;}
.tut-btn{font-family:'Press Start 2P',monospace;font-size:7px;padding:6px 14px;cursor:pointer;border:2px solid var(--red);background:#2a0010;color:#fff;transition:background .15s;}
.tut-btn:hover{background:#4a0018;}
.tut-btn.green{border-color:var(--green);background:#0a2010;}.tut-btn.green:hover{background:#1a3a1a;}
#tutorialBadge{display:none;position:absolute;top:8px;right:14px;font-family:'Press Start 2P',monospace;font-size:7px;color:#000;background:var(--green);border:2px solid #1eff88;border-bottom-color:#007733;border-right-color:#007733;box-shadow:2px 2px 0 #000;padding:4px 8px;z-index:25;pointer-events:none;animation:tutBadgePulse 2s ease-in-out infinite;}
#tutorialBadge.show{display:block;}
@keyframes tutDotPulse{0%{opacity:1}100%{opacity:.3}}

@keyframes tutHL{0%,100%{box-shadow:0 0 0 2px var(--red),0 0 12px #e8334a66}50%{box-shadow:0 0 0 4px var(--red),0 0 20px #e8334a99}}
.round-screen{position:fixed;inset:0;background:rgba(0,0,0,.93);z-index:500;display:none;align-items:center;justify-content:center;flex-direction:column;gap:14px;}.round-screen.active{display:flex;}
.round-title{font-size:22px;color:var(--accent);text-shadow:4px 4px 0 var(--red);animation:titlePulse 1s ease-in-out infinite;}
.round-subtitle{font-family:'VT323',monospace;font-size:26px;color:var(--white);}
.round-event-box{background:#13132b;border:3px solid var(--red);padding:14px 28px;text-align:center;box-shadow:6px 6px 0 #000;max-width:420px;}.round-event-box .event-head{font-size:8px;color:var(--red);margin-bottom:6px;}.round-event-box p{font-family:'VT323',monospace;font-size:20px;color:#ff8888;line-height:1.5;}
.round-info-box{background:#0a1a0a;border:2px solid var(--green);padding:10px 20px;text-align:center;max-width:420px;}.round-info-box p{font-family:'VT323',monospace;font-size:17px;color:var(--green);line-height:1.5;}
.round-btn{font-family:'Press Start 2P',monospace;font-size:11px;background:var(--green);color:#000;border:var(--px) solid #1eff88;border-bottom-color:#007733;border-right-color:#007733;box-shadow:4px 4px 0 #000;padding:13px 30px;cursor:pointer;}.round-btn:hover{background:#5fffaa;}
.gameover-screen{position:fixed;inset:0;background:rgba(0,0,0,.96);z-index:600;display:none;align-items:center;justify-content:center;flex-direction:column;gap:11px;}.gameover-screen.active{display:flex;}
.gameover-title{font-size:22px;color:var(--red);text-shadow:4px 4px 0 #000;animation:titlePulse 1s infinite;}.gameover-grade{font-size:44px;color:var(--accent);text-shadow:5px 5px 0 var(--red);}
.gameover-stat{font-family:'VT323',monospace;font-size:22px;color:var(--white);}.gameover-stat span{color:var(--accent);}
.upgrades-box{background:#13132b;border:3px solid var(--accent);padding:14px 22px;box-shadow:6px 6px 0 #000;max-width:460px;width:90%;}.upgrades-box h3{font-size:9px;color:var(--accent);text-align:center;margin-bottom:10px;}
.upgrade-row{display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:7px;background:#0a0a16;padding:7px 9px;border:2px solid #1e1e3a;}
.upgrade-info{font-family:'VT323',monospace;font-size:15px;color:var(--white);}.upgrade-info small{font-size:12px;color:#666;display:block;}
.upgrade-buy{font-family:'Press Start 2P',monospace;font-size:7px;padding:5px 8px;background:var(--green);color:#000;border:2px solid #1eff88;border-bottom-color:#007733;border-right-color:#007733;box-shadow:2px 2px 0 #000;cursor:pointer;}
.upgrade-buy:disabled{background:#1a2a1a;color:#446644;cursor:not-allowed;border-color:#223322;}.upgrade-buy:not(:disabled):hover{background:#5fffaa;}
.upgrade-owned{font-family:'VT323',monospace;font-size:13px;color:var(--accent);}
.go-btn{font-family:'Press Start 2P',monospace;font-size:10px;padding:13px 26px;cursor:pointer;border:var(--px) solid;box-shadow:4px 4px 0 #000;margin:4px;}
.go-btn.retry{background:var(--red);color:#fff;border-color:#ff6b7a;border-bottom-color:#7a0f1f;border-right-color:#7a0f1f;}.go-btn.menu{background:var(--blue);color:#fff;border-color:#7cd4ff;border-bottom-color:#1b567a;border-right-color:#1b567a;}.go-btn:hover{filter:brightness(1.2);}
.coin-pop{position:fixed;pointer-events:none;z-index:9990;font-family:'Press Start 2P',monospace;font-size:10px;animation:coinFloat .8s ease-out forwards;}
@keyframes coinFloat{0%{opacity:1;transform:translateY(0)}100%{opacity:0;transform:translateY(-50px)}}
.upg-badge{font-size:13px;opacity:.3;}.upg-badge.on{opacity:1;filter:drop-shadow(0 0 4px gold);}
.power-flash{position:fixed;inset:0;pointer-events:none;z-index:50;border:4px solid gold;animation:pfl .35s ease-out forwards;}
@keyframes pfl{from{opacity:.7}to{opacity:0}}
</style>
</head>
<body>
<div id="stars"></div>
<div class="skyline"><svg viewBox="0 0 1440 160" preserveAspectRatio="none" xmlns="http://www.w3.org/2000/svg">
<rect x="0" y="60" width="60" height="100" fill="#0a0a18"/><rect x="70" y="80" width="80" height="80" fill="#0a0a18"/>
<rect x="160" y="30" width="50" height="130" fill="#0a0a18"/><rect x="175" y="10" width="8" height="20" fill="#0a0a18"/>
<rect x="220" y="70" width="70" height="90" fill="#0a0a18"/><rect x="300" y="50" width="40" height="110" fill="#0a0a18"/>
<rect x="350" y="90" width="90" height="70" fill="#0a0a18"/><rect x="450" y="40" width="55" height="120" fill="#0a0a18"/>
<rect x="465" y="20" width="8" height="22" fill="#f7c948" opacity="0.5"/><rect x="515" y="65" width="70" height="95" fill="#0a0a18"/>
<rect x="595" y="45" width="45" height="115" fill="#0a0a18"/><rect x="650" y="75" width="80" height="85" fill="#0a0a18"/>
<rect x="740" y="55" width="50" height="105" fill="#0a0a18"/><rect x="752" y="35" width="8" height="22" fill="#e8334a" opacity="0.4"/>
<rect x="800" y="80" width="70" height="80" fill="#0a0a18"/><rect x="880" y="35" width="60" height="125" fill="#0a0a18"/>
<rect x="950" y="65" width="80" height="95" fill="#0a0a18"/><rect x="1040" y="50" width="45" height="110" fill="#0a0a18"/>
<rect x="1095" y="70" width="70" height="90" fill="#0a0a18"/><rect x="1175" y="45" width="55" height="115" fill="#0a0a18"/>
<rect x="1240" y="60" width="80" height="100" fill="#0a0a18"/><rect x="1330" y="75" width="60" height="85" fill="#0a0a18"/>
<rect x="165" y="50" width="6" height="6" fill="#f7c948" opacity="0.7"/><rect x="455" y="55" width="6" height="6" fill="#3a9bd5" opacity="0.8"/>
<rect x="600" y="60" width="6" height="6" fill="#e8334a" opacity="0.7"/><rect x="884" y="55" width="6" height="6" fill="#f7c948" opacity="0.8"/>
</svg></div>
<div id="floaters"></div><div id="dragGhost"></div>

<div id="menuScreen" class="screen active">
<div style="display:flex;flex-direction:column;align-items:center;position:relative;z-index:10;">
<div class="title-card">
<div style="margin:0 auto 14px;width:200px;height:110px;position:relative;">
<canvas id="bhCanvas" width="200" height="110" style="display:block;image-rendering:pixelated;"></canvas>
</div>
<div class="game-title">DIHLICKVERY</div>
<div class="subtitle">because it rhymes with DELIVERY!</div>
<div class="pixel-divider"></div></div>
<div class="buttons-panel">
<button class="px-btn btn-play" id="btnPlay">&#127829;  PLAY</button>
<button class="px-btn btn-tutorial" id="btnTutorial">&#10067;  TUTORIAL</button>
<button class="px-btn btn-credits" id="btnCredits">&#128220;  CREDITS</button>
<button class="px-btn btn-sandbox" id="btnSandbox">&#129514;  SANDBOX</button>
<div class="version">VER 0.2.0 &nbsp;|&nbsp; 2026</div>
</div></div></div>

<div class="modal-overlay" id="creditsModal"><div class="modal-box">
<h2>&#128220; CREDITS</h2>
<p>GAME DESIGN &amp; CONCEPT</p><p class="role">&#9733; SSSC &#9733;</p><br>
<p>DEVELOPMENT</p><p class="role">DIHLICKVERY TEAM</p><br>
<p>PIXEL ART &amp; MUSIC</p><p class="role">CALM THE CLAUDE</p><br>
<p>COLLABORATORS</p><p class="role">&#129309; BAITOEY + ICE + GRACE</p><br>
<p>SPECIAL THANKS</p><p class="role">&#129380; COLA &amp; PIZZA &#127829;</p>
<button class="modal-close" id="closeCredits">&#10005; CLOSE</button>
<div class="honor-bubble" id="honorBubble">&gt; Make</div>
<button class="honor-btn" id="honorBtn">HONORABLE<br>MENTION</button>
</div></div>

<div id="gameScreen" class="screen">
<div id="tutorialBadge">&#128214; TUTORIAL MODE</div>
<div class="hud" id="hudArea">
<div class="hud-block"><span class="hud-label">CASH</span><span class="hud-value green" id="hudCash">$60</span></div>
<div class="hud-block"><span class="hud-label">PROFIT</span><span class="hud-value" id="hudProfit">+$0</span></div>
<div class="hud-block"><span class="hud-label">TIME</span><div class="timer-bar-bg"><div class="timer-bar-fill" id="timerBar" style="width:100%"></div></div></div>
<div class="hud-block"><span class="hud-label">ROUND</span><span class="hud-value" id="hudRound">1</span></div>
<div class="hud-block"><span class="hud-label">UPGRADES</span><div style="display:flex;gap:3px;">
<span class="upg-badge" id="ubike">&#128755;</span><span class="upg-badge" id="ubag">&#128230;</span>
<span class="upg-badge" id="uvip">&#11088;</span><span class="upg-badge" id="uintel">&#128202;</span></div></div>
<button id="btnPause" style="font-family:'Press Start 2P',monospace;font-size:8px;background:#1a1a30;color:#888;border:2px solid #333;padding:6px 10px;cursor:pointer;">&#9208;</button>
</div>
<div class="game-body">
<div class="shop-panel" id="shopPanel">
<div class="shop-title">&#127978; SHOP</div><div id="shopItems"></div>
<div class="inventory-section"><div class="inv-title">&#128230; INVENTORY</div><div id="inventorySlots"><div class="inv-empty">Empty</div></div></div>
<div class="combo-tray" id="comboTray">
<div class="combo-title">&#127873; BUILD SET</div>
<div class="combo-staging" id="comboSlots"></div>
<button class="combo-make-btn" id="comboMakeBtn" disabled>&#10010; CREATE SET</button>
<button class="combo-clear" id="comboClear">&#10005; CLEAR STAGING</button>
<div class="set-boxes" id="setBoxes"></div>
</div>
</div>
<div class="map-area" id="mapArea"><canvas id="mapCanvas" class="map-canvas"></canvas><div id="mapBuildings"></div><div id="mapRider">&#128755;</div></div>
<div class="market-panel" id="marketPanel">
<div class="market-title">&#128200; MARKET</div><div id="marketRows"></div>
<div id="marketEventBox" style="display:none;"></div>
<div class="power-panel" id="powerPanel" style="display:none;"><div class="power-title">&#9889; POWERS</div><div id="powerButtons"></div></div>
</div></div>
<div class="status-bar"><span class="status-msg" id="statusMsg">&#9658; BUY items then DRAG to buildings!</span><div class="capacity-bar" id="capacityBar"></div></div>
</div>

<div id="tutOverlay">
  <div id="tutDark"></div>
  <div class="tut-card" id="tutCard" style="display:none;">
    <div class="tut-card-header">
      <span class="tut-card-tag" id="tutTag">TUTORIAL</span>
      <span class="tut-card-msg" id="tutMsg"></span>
    </div>
    <div class="tut-card-action" id="tutAction"></div>
    <div class="tut-card-footer" id="tutFooter"></div>
  </div>
</div>

<div class="round-screen" id="roundScreen">
<div class="round-title" id="rTitle">GET READY!</div>
<div class="round-subtitle" id="rSubtitle">Wall Street is hungry!</div>
<div class="round-event-box"><div class="event-head">&#128240; MARKET NEWS</div><p id="rEventText">Markets are calm.</p></div>
<div class="round-info-box" id="rInfoBox" style="display:none;"><p id="rInfoText"></p></div>
<button class="round-btn" id="roundStartBtn">&#9658; START ROUND</button>
</div>

<div class="gameover-screen" id="gameoverScreen">
<div class="gameover-title" id="goTitle">GAME OVER</div>
<div class="gameover-grade" id="goGrade">C</div>
<div class="gameover-stat">TOTAL PROFIT: <span id="goProfit">$0</span></div>
<div class="gameover-stat">TARGET: <span id="goTarget">$280</span></div>
<div class="gameover-stat">DELIVERIES: <span id="goDeliveries">0</span></div>
<div class="upgrades-box"><h3>&#128295; SPEND YOUR EARNINGS ON UPGRADES</h3><div id="upgradesList"></div></div>
<div style="display:flex;gap:8px;margin-top:6px;">
<button class="go-btn retry" id="goRetry">&#8634; PLAY AGAIN</button>
<button class="go-btn menu" id="goMenu">&#8962; MENU</button>
</div></div>

<!-- TIME CUBE WARNING MODAL -->
<div class="modal-overlay" id="timeCubeModal">
<div class="modal-box" style="border-color:cyan;box-shadow:8px 8px 0 #000,0 0 40px #00ffff44;max-width:420px;">
<div id="timeCubeIcon" style="margin:0 auto 16px;width:80px;height:80px;"></div>
<h2 style="color:cyan;text-shadow:3px 3px 0 #006688;font-size:11px;">WARNING</h2>
<p style="font-family:'VT323',monospace;font-size:19px;color:#aaffff;line-height:1.6;margin-bottom:18px;">The Time Cube is extremely unstable. Possessing such power can cause the universe to cease to exist.<br><br>Do you wish to proceed?</p>
<div style="display:flex;gap:12px;justify-content:center;">
<button id="tcYes" style="font-family:'Press Start 2P',monospace;font-size:11px;background:cyan;color:#000;border:3px solid #00aacc;box-shadow:3px 3px 0 #000;padding:10px 22px;cursor:pointer;">YES</button>
<button id="tcNo" style="font-family:'Press Start 2P',monospace;font-size:11px;background:#222;color:#aaa;border:3px solid #444;box-shadow:3px 3px 0 #000;padding:10px 22px;cursor:pointer;">NO</button>
</div>
</div></div>

<!-- ENDING 1: TIME CUBE DELIVERY -->
<div id="ending1Screen" style="display:none;position:fixed;inset:0;z-index:9000;background:#000;align-items:center;justify-content:center;flex-direction:column;">
<div id="e1BlueOverlay" style="position:fixed;inset:0;background:blue;opacity:0;pointer-events:none;transition:opacity 0.1s;"></div>
<div id="e1Clock" style="display:none;position:relative;z-index:2;text-align:center;">
<svg id="e1ClockSvg" width="220" height="220" viewBox="0 0 220 220"></svg>
<div id="e1Text" style="font-family:'Press Start 2P',monospace;font-size:11px;color:#00ff00;margin-top:24px;max-width:420px;line-height:1.8;text-align:center;text-shadow:0 0 10px #00ff00;opacity:0;transition:opacity 1s;"></div>
</div>
</div>

<!-- ENDING 2: SECRET ENDING -->
<div id="ending2Screen" style="display:none;position:fixed;inset:0;z-index:9500;background:#000;align-items:center;justify-content:center;flex-direction:column;">
<div id="e2GlitchOverlay" style="position:fixed;inset:0;z-index:1;display:none;"></div>
<div id="e2Text" style="position:relative;z-index:2;font-family:'Press Start 2P',monospace;font-size:10px;color:#fff;max-width:520px;line-height:2;text-align:center;"></div>
</div>

<script>

/* DETAILED BLACK HOLE LOGO */
(function(){
  const canvas=document.getElementById('bhCanvas');if(!canvas)return;
  const ctx=canvas.getContext('2d');
  const W=200,H=110,cx=100,cy=58,R=24;
  let t=0;
  const PX=2;

  // Precompute accretion disk particles
  const diskParticles=[];
  for(let i=0;i<220;i++){
    const angle=Math.random()*Math.PI*2;
    const r=R*1.25+Math.random()*R*2.8;
    const speed=(0.008+0.022*(1/(r/R)));
    const brightness=0.4+Math.random()*0.6;
    const colorIdx=Math.floor(Math.random()*5);
    const ySquish=0.28+0.12*(r/(R*4));
    diskParticles.push({angle,r,speed,brightness,colorIdx,ySquish,phase:Math.random()*Math.PI*2});
  }
  // Jet particles (polar jets)
  const jetParticles=[];
  for(let i=0;i<30;i++){
    jetParticles.push({
      y:-(R+10+Math.random()*35),x:(Math.random()-.5)*8,
      vy:-(0.4+Math.random()*0.6),alpha:0.3+Math.random()*0.5,phase:Math.random()*Math.PI*2
    });
  }

  const DISK_COLORS=['#ff2200','#ff6600','#ff9900','#ffdd00','#ffffff'];

  function lerp(a,b,t){return a+(b-a)*t;}
  function lerpCol(ca,cb,tt){
    const pa=parseInt(ca.slice(1),16),pb=parseInt(cb.slice(1),16);
    const r=((pa>>16)&0xff),g=((pa>>8)&0xff),b=(pa&0xff);
    const r2=((pb>>16)&0xff),g2=((pb>>8)&0xff),b2=(pb&0xff);
    return `rgb(${(r+tt*(r2-r))|0},${(g+tt*(g2-g))|0},${(b+tt*(b2-b))|0})`;
  }

  function drawFrame(){
    ctx.clearRect(0,0,W,H);
    // Deep space gradient behind
    const bg=ctx.createRadialGradient(cx,cy,R*0.5,cx,cy,W*0.8);
    bg.addColorStop(0,'#06001a');bg.addColorStop(1,'#000000');
    ctx.fillStyle=bg;ctx.fillRect(0,0,W,H);

    // Bob
    const bob=Math.sin(t*0.018)*4;
    const BY=cy+bob;

    // ‚îÄ‚îÄ‚îÄ BEHIND HALF of accretion disk ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    diskParticles.forEach(p=>{
      p.angle+=p.speed;
      const px=cx+Math.cos(p.angle)*p.r;
      const py=BY+Math.sin(p.angle)*p.r*p.ySquish;
      // Only draw "behind" if in back half (sin < 0 means behind BH)
      if(Math.sin(p.angle)>=0)return;
      const distFromCenter=Math.sqrt((px-cx)**2+((py-BY)/p.ySquish)**2);
      if(distFromCenter<R*1.05)return;
      // Heat map based on distance
      const heat=1-(p.r-R*1.25)/(R*2.8);
      const ci=Math.min(4,Math.floor(heat*4.5));
      const col=lerpCol(DISK_COLORS[ci],DISK_COLORS[Math.min(4,ci+1)],heat*4.5-ci);
      const flicker=0.65+0.35*Math.sin(t*0.12+p.phase);
      ctx.globalAlpha=p.brightness*flicker*(0.55+0.45*heat);
      ctx.fillStyle=col;
      const ps=Math.max(PX,PX+heat*1.5|0);
      ctx.fillRect(px|0,py|0,ps,ps);
    });

    // ‚îÄ‚îÄ‚îÄ GLOW around event horizon ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // Outer diffuse orange glow
    const outerGlow=ctx.createRadialGradient(cx,BY,R*0.8,cx,BY,R*3.5);
    outerGlow.addColorStop(0,'rgba(255,80,0,0.22)');
    outerGlow.addColorStop(0.4,'rgba(255,30,0,0.08)');
    outerGlow.addColorStop(1,'rgba(0,0,0,0)');
    ctx.globalAlpha=1;ctx.fillStyle=outerGlow;
    ctx.beginPath();ctx.ellipse(cx,BY,R*3.5,R*1.6,0,0,Math.PI*2);ctx.fill();

    // Photon sphere ring (bright thin arc around BH)
    for(let a=0;a<Math.PI*2;a+=0.04){
      const pr=R+2.5;
      const ax=cx+Math.cos(a)*pr,ay=BY+Math.sin(a)*pr*0.44;
      const brightness=0.7+0.3*Math.sin(a*2+t*0.04);
      ctx.globalAlpha=brightness*0.9;
      ctx.fillStyle='#fff8d0';
      ctx.fillRect(ax|0,ay|0,PX,PX);
    }

    // ‚îÄ‚îÄ‚îÄ EVENT HORIZON (perfect black circle) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    ctx.globalAlpha=1;
    ctx.beginPath();ctx.arc(cx,BY,R+1.5,0,Math.PI*2);ctx.fillStyle='#000';ctx.fill();

    // Inner photon ring glow on front edge
    const innerGlow=ctx.createRadialGradient(cx,BY,R-3,cx,BY,R+5);
    innerGlow.addColorStop(0,'rgba(0,0,0,0)');
    innerGlow.addColorStop(0.6,'rgba(255,120,0,0.25)');
    innerGlow.addColorStop(1,'rgba(255,200,50,0.55)');
    ctx.fillStyle=innerGlow;
    ctx.beginPath();ctx.arc(cx,BY,R+5,0,Math.PI*2);ctx.fill();
    // Re-stamp black core
    ctx.beginPath();ctx.arc(cx,BY,R,0,Math.PI*2);ctx.fillStyle='#000';ctx.fill();

    // ‚îÄ‚îÄ‚îÄ FRONT HALF of accretion disk ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    diskParticles.forEach(p=>{
      const px=cx+Math.cos(p.angle)*p.r;
      const py=BY+Math.sin(p.angle)*p.r*p.ySquish;
      if(Math.sin(p.angle)<0)return; // only front half
      const distFromCenter=Math.sqrt((px-cx)**2+((py-BY)/p.ySquish)**2);
      if(distFromCenter<R*1.02)return;
      const heat=1-(p.r-R*1.25)/(R*2.8);
      const ci=Math.min(4,Math.floor(heat*4.5));
      const col=lerpCol(DISK_COLORS[ci],DISK_COLORS[Math.min(4,ci+1)],heat*4.5-ci);
      const flicker=0.65+0.35*Math.sin(t*0.12+p.phase);
      ctx.globalAlpha=p.brightness*flicker*(0.65+0.35*heat);
      ctx.fillStyle=col;
      const ps=Math.max(PX,PX+heat*2|0);
      ctx.fillRect(px|0,py|0,ps,ps);
    });

    // ‚îÄ‚îÄ‚îÄ RELATIVISTIC JETS (top & bottom) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    jetParticles.forEach(p=>{
      p.y+=p.vy;p.x+=(Math.random()-.5)*0.3;
      if(p.y<-(R+50)){p.y=-(R+6+Math.random()*4);p.x=(Math.random()-.5)*4;}
      const jx=cx+p.x,jy=BY+p.y;
      const alpha=p.alpha*Math.sin(t*0.08+p.phase)*0.5+0.25;
      ctx.globalAlpha=Math.max(0,Math.min(0.7,alpha));
      ctx.fillStyle='#88aaff';
      ctx.fillRect(jx|0,jy|0,2,2);
      // Mirror bottom jet
      ctx.fillRect(jx|0,(BY+(-p.y))|0,2,2);
    });

    // ‚îÄ‚îÄ‚îÄ GRAVITATIONAL LENSING ARC (Einstein ring suggestion) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    ctx.globalAlpha=0.18;
    ctx.strokeStyle='#ffeeaa';ctx.lineWidth=1;
    ctx.beginPath();ctx.ellipse(cx,BY,R*4.2,R*1.0,0,Math.PI*0.12,Math.PI*0.88);ctx.stroke();
    ctx.beginPath();ctx.ellipse(cx,BY,R*4.2,R*1.0,0,Math.PI*1.12,Math.PI*1.88);ctx.stroke();

    ctx.globalAlpha=1;
    t++;
    requestAnimationFrame(drawFrame);
  }
  drawFrame();
})();

/* TIME CUBE ICON CANVAS */
function drawTimeCubeIcon(canvas){
  const ctx=canvas.getContext('2d');
  const W=canvas.width,H=canvas.height;
  let t=0;
  function frame(){
    ctx.clearRect(0,0,W,H);
    // Clock face background
    const cx=W/2,cy=H/2,cr=W/2-2;
    ctx.fillStyle='#001133';ctx.beginPath();ctx.arc(cx,cy,cr,0,Math.PI*2);ctx.fill();
    ctx.strokeStyle='#0044aa';ctx.lineWidth=2;ctx.beginPath();ctx.arc(cx,cy,cr,0,Math.PI*2);ctx.stroke();
    // Roman numeral ticks
    const romans=['XII','III','VI','IX'];
    ctx.fillStyle='#2266ff';ctx.font=`bold ${W*.12}px serif`;ctx.textAlign='center';ctx.textBaseline='middle';
    romans.forEach((r,i)=>{const a=i*Math.PI/2-Math.PI/2;ctx.fillText(r,cx+Math.cos(a)*cr*.72,cy+Math.sin(a)*cr*.72);});
    // Clock hands
    const hr=t*0.005,mr=t*0.06;
    ctx.strokeStyle='#4488ff';ctx.lineWidth=2;
    ctx.beginPath();ctx.moveTo(cx,cy);ctx.lineTo(cx+Math.cos(hr-Math.PI/2)*cr*.45,cy+Math.sin(hr-Math.PI/2)*cr*.45);ctx.stroke();
    ctx.lineWidth=1.5;
    ctx.beginPath();ctx.moveTo(cx,cy);ctx.lineTo(cx+Math.cos(mr-Math.PI/2)*cr*.62,cy+Math.sin(mr-Math.PI/2)*cr*.62);ctx.stroke();
    // Spinning cyan 3D cube
    const s=W*.28,ox=cx,oy=cy;
    const angle=t*0.04;
    const verts=[[-1,-1,-1],[1,-1,-1],[1,1,-1],[-1,1,-1],[-1,-1,1],[1,-1,1],[1,1,1],[-1,1,1]];
    function project(v){
      const x=v[0]*Math.cos(angle)-v[2]*Math.sin(angle);
      const z=v[0]*Math.sin(angle)+v[2]*Math.cos(angle);
      const y2=v[1]*Math.cos(0.4)-z*Math.sin(0.4);
      const z2=v[1]*Math.sin(0.4)+z*Math.cos(0.4);
      const fov=2.5+z2*.15;
      return [ox+x/fov*s,oy+y2/fov*s,z2];
    }
    const p=verts.map(project);
    const faces=[[0,1,2,3],[4,5,6,7],[0,1,5,4],[2,3,7,6],[0,3,7,4],[1,2,6,5]];
    const faceColors=['rgba(0,255,255,0.18)','rgba(0,200,255,0.14)','rgba(0,180,255,0.12)','rgba(0,160,255,0.10)','rgba(0,140,255,0.09)','rgba(0,120,255,0.07)'];
    faces.forEach((f,i)=>{
      ctx.beginPath();ctx.moveTo(p[f[0]][0],p[f[0]][1]);
      f.forEach(vi=>ctx.lineTo(p[vi][0],p[vi][1]));ctx.closePath();
      ctx.fillStyle=faceColors[i];ctx.fill();
      ctx.strokeStyle=`rgba(0,255,255,${0.7+Math.sin(t*.05)*0.3})`;ctx.lineWidth=1.5;ctx.stroke();
    });
    t++;requestAnimationFrame(frame);
  }
  frame();
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SFX ENGINE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let _ac=null;
function getAC(){
  if(!_ac||_ac.state==='closed'){
    try{_ac=new(window.AudioContext||window.webkitAudioContext)();}catch(e){return null;}
  }
  if(_ac.state==='suspended')_ac.resume();
  return _ac;
}
function sfx(type){
  const ac=getAC();if(!ac)return;
  const t=ac.currentTime;
  const osc=ac.createOscillator(),g=ac.createGain();
  osc.connect(g);g.connect(ac.destination);
  switch(type){
    case'buy':
      osc.type='square';osc.frequency.setValueAtTime(440,t);osc.frequency.setValueAtTime(660,t+0.06);
      g.gain.setValueAtTime(0.15,t);g.gain.exponentialRampToValueAtTime(0.001,t+0.18);
      osc.start(t);osc.stop(t+0.18);break;
    case'deliver':
      osc.type='triangle';
      osc.frequency.setValueAtTime(523,t);osc.frequency.setValueAtTime(784,t+0.07);osc.frequency.setValueAtTime(1046,t+0.14);
      g.gain.setValueAtTime(0.2,t);g.gain.exponentialRampToValueAtTime(0.001,t+0.3);
      osc.start(t);osc.stop(t+0.3);break;
    case'add':
      osc.type='sine';osc.frequency.setValueAtTime(600,t);osc.frequency.setValueAtTime(800,t+0.05);
      g.gain.setValueAtTime(0.1,t);g.gain.exponentialRampToValueAtTime(0.001,t+0.12);
      osc.start(t);osc.stop(t+0.12);break;
    case'create':
      osc.type='square';
      osc.frequency.setValueAtTime(330,t);osc.frequency.setValueAtTime(440,t+0.06);osc.frequency.setValueAtTime(660,t+0.12);osc.frequency.setValueAtTime(880,t+0.18);
      g.gain.setValueAtTime(0.18,t);g.gain.exponentialRampToValueAtTime(0.001,t+0.32);
      osc.start(t);osc.stop(t+0.32);break;
    case'click':
      osc.type='sine';osc.frequency.setValueAtTime(700,t);
      g.gain.setValueAtTime(0.08,t);g.gain.exponentialRampToValueAtTime(0.001,t+0.07);
      osc.start(t);osc.stop(t+0.07);break;
    case'impatient':
      osc.type='sawtooth';osc.frequency.setValueAtTime(200,t);osc.frequency.linearRampToValueAtTime(80,t+0.2);
      g.gain.setValueAtTime(0.15,t);g.gain.exponentialRampToValueAtTime(0.001,t+0.22);
      osc.start(t);osc.stop(t+0.22);break;
    case'roundStart':
      osc.type='square';
      osc.frequency.setValueAtTime(220,t);osc.frequency.setValueAtTime(440,t+0.1);osc.frequency.setValueAtTime(880,t+0.2);
      g.gain.setValueAtTime(0.2,t);g.gain.setValueAtTime(0.2,t+0.25);g.gain.exponentialRampToValueAtTime(0.001,t+0.45);
      osc.start(t);osc.stop(t+0.45);break;
    case'power':
      osc.type='sawtooth';osc.frequency.setValueAtTime(100,t);osc.frequency.exponentialRampToValueAtTime(600,t+0.25);
      g.gain.setValueAtTime(0.18,t);g.gain.exponentialRampToValueAtTime(0.001,t+0.3);
      osc.start(t);osc.stop(t+0.3);break;
    case'timecubeUnlock': {
      // Single deep clock tick + rising shimmer
      const osc2=ac.createOscillator(),g2=ac.createGain();
      osc2.connect(g2);g2.connect(ac.destination);
      osc.type='square';osc.frequency.setValueAtTime(55,t);
      g.gain.setValueAtTime(0.4,t);g.gain.exponentialRampToValueAtTime(0.001,t+0.6);
      osc.start(t);osc.stop(t+0.6);
      osc2.type='sine';osc2.frequency.setValueAtTime(1200,t+0.1);osc2.frequency.exponentialRampToValueAtTime(2400,t+0.5);
      g2.gain.setValueAtTime(0.0,t+0.1);g2.gain.linearRampToValueAtTime(0.12,t+0.2);g2.gain.exponentialRampToValueAtTime(0.001,t+0.55);
      osc2.start(t+0.1);osc2.stop(t+0.55);
      break;
    }
  }
}

const starsEl=document.getElementById('stars');
for(let i=0;i<80;i++){
  const s=document.createElement('div');s.className='star';
  s.style.cssText=`left:${Math.random()*100}%;top:${Math.random()*100}%;--d:${1.5+Math.random()*3}s;animation-delay:${Math.random()*3}s;width:${Math.random()>.7?'4px':'2px'};height:${Math.random()>.7?'4px':'2px'};opacity:${.2+Math.random()*.5}`;
  starsEl.appendChild(s);
}
['üçï','ü•§','üíµ','üí∞','üì¶','üõµ','‚≠ê','üí≤'].forEach((em,i)=>{
  const d=document.createElement('div');d.className='float-item';d.textContent=em;
  d.style.cssText=`left:${5+(i/8)*90}%;--d:${8+Math.random()*10}s;animation-delay:${Math.random()*10}s`;
  document.getElementById('floaters').appendChild(d);
});

const ROUND_TIME=60;
const PRODUCTS=[
  {id:'pizza',name:'PIZZA',icon:'üçï',baseBuy:8,baseSell:18},
  {id:'cola',name:'COLA',icon:'ü•§',baseBuy:3,baseSell:8},
  {id:'wings',name:'WINGS',icon:'üçó',baseBuy:10,baseSell:22},
  {id:'coffee',name:'COFFEE',icon:'‚òï',baseBuy:4,baseSell:10},
];
const BUILDINGS=[
  {id:'bull',name:'BULL BANK',cx:.13,cy:.22,color:'#0d1f3c',accent:'#3a9bd5',w:68,h:92},
  {id:'bear',name:'BEAR BROKERS',cx:.32,cy:.28,color:'#280e0e',accent:'#e8334a',w:58,h:74},
  {id:'nyse',name:'NYSE TOWER',cx:.52,cy:.12,color:'#22220a',accent:'#f7c948',w:78,h:108},
  {id:'fed',name:'THE FED',cx:.70,cy:.30,color:'#0e201a',accent:'#3ddc84',w:64,h:84},
  {id:'gold',name:'GOLD EXCHANGE',cx:.84,cy:.18,color:'#201808',accent:'#f7c948',w:54,h:68},
  {id:'vip',name:'VIP SUITE ‚≠ê',cx:.50,cy:.58,color:'#180e28',accent:'#cc88ff',w:72,h:58,vipOnly:true},
  {id:'hedge',name:'HEDGE FUND',cx:.20,cy:.60,color:'#0a1a2a',accent:'#66ccff',w:60,h:70,lateOnly:true},
  {id:'sec',name:'SEC OFFICE',cx:.76,cy:.58,color:'#1a1a0a',accent:'#aadd44',w:56,h:66,lateOnly:true},
];
const EVENTS=[
  {text:'üìà BULL RUN!\nPizza demand DOUBLED!',fx:p=>{if(p.id==='pizza')p.sell*=2;}},
  {text:'üìâ MARKET CRASH!\nCola stress-drinking. Cola +60%!',fx:p=>{if(p.id==='cola')p.sell=Math.floor(p.sell*1.6);}},
  {text:'üå°Ô∏è HEAT WAVE!\nCola flying off shelves. Cola x2!',fx:p=>{if(p.id==='cola')p.sell*=2;}},
  {text:'üíº BOARD MEETING!\nCoffee demand sky-high. Coffee x2!',fx:p=>{if(p.id==='coffee')p.sell*=2;}},
  {text:'üçó WING WEDNESDAY!\nEvery floor wants Wings. Wings +80%!',fx:p=>{if(p.id==='wings')p.sell=Math.floor(p.sell*1.8);}},
  {text:'üò¥ QUIET FRIDAY\nMarkets calm. Standard prices.',fx:()=>{}},
  {text:'üîî IPO DAY!\nAll prices surge. Everything +35%!',fx:p=>{p.sell=Math.floor(p.sell*1.35);}},
  {text:'üè¶ MERGER MANIA!\nPizza & Wings are HOT. +45% each!',fx:p=>{if(p.id==='pizza'||p.id==='wings')p.sell=Math.floor(p.sell*1.45);}},
];
const POWERS=[
  {id:'priceUp',icon:'üìà',name:'PRICE BOOST',desc:'All sell prices +50% for 10s',cost:25,duration:10000},
  {id:'moreDemand',icon:'üèôÔ∏è',name:'MORE DEMAND',desc:'Spawns extra orders for 10s',cost:20,duration:10000},
  {id:'quickBuy',icon:'‚ö°',name:'QUICK BUY',desc:'Click item = instant buy (PERM)',cost:35,duration:0,oneTime:true},
  {id:'timeCube',icon:'‚è±',name:'TIME CUBE',desc:'???',cost:888,special:true},
];
const UPGRADES_DEF=[
  {key:'bike',icon:'üõµ',name:'FASTER BIKE',desc:'+speed (visual)',cost:[30,60],max:2},
  {key:'bag',icon:'üì¶',name:'BIGGER BAG',desc:'+2 inv slots',cost:[40,80],max:2},
  {key:'vip',icon:'‚≠ê',name:'VIP ACCESS',desc:'Unlock VIP Suite',cost:[50],max:1},
  {key:'intel',icon:'üìä',name:'MARKET INTEL',desc:'Preview next event',cost:[45],max:1},
];

let G={};
function resetGame(){
  const savedUpg=G.upgrades||{bike:0,bag:0,vip:false,intel:false,quickBuy:false};
  G={cash:60,profit:0,round:0,active:false,timeLeft:ROUND_TIME,timer:null,
     inventory:[],orders:{},orderTimers:{},deliveries:0,combos:0,
     upgrades:savedUpg,upgradePoints:0,prices:[],event:null,
     activePowers:{priceUp:false,moreDemand:false},combo:[],sets:[],impatientExpired:0,
     timeCubeUnlocked:false,timeCubes:0,allTimeCashEver:0};
}
resetGame();

function showScreen(id){
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

function initPrices(ev){
  G.prices=PRODUCTS.map(p=>{
    const m={...p};
    m.buy=Math.max(1,m.baseBuy+Math.round((Math.random()-.5)*4));
    m.sell=Math.max(m.buy+2,m.baseSell+Math.round((Math.random()-.5)*6));
    if(ev)ev.fx(m);return m;
  });
}
function getSellPrice(p){return G.activePowers.priceUp?Math.floor(p.sell*1.5):p.sell;}

function renderMarket(){
  const el=document.getElementById('marketRows');el.innerHTML='';
  G.prices.forEach(p=>{
    const div=document.createElement('div');div.className='market-row';
    const sell=getSellPrice(p),trend=p.sell>p.baseSell?'up':p.sell<p.baseSell?'down':'';
    div.innerHTML=`<div class="market-row-name">${p.icon} ${p.name}</div>
      <div class="market-row-price ${trend}">$${p.buy}&#8594;<span style="color:${G.activePowers.priceUp?'#ffcc00':'var(--green)'}">$${sell}</span></div>`;
    el.appendChild(div);
  });
  const evBox=document.getElementById('marketEventBox');
  if(G.event){evBox.style.display='block';evBox.innerHTML=`<div class="market-event-box"><div class="market-event-title">üì∞ EVENT</div><div class="market-event-text">${G.event.text.replace(/\n/g,'<br>')}</div></div>`;}
  else evBox.style.display='none';
}

function maxSlots(){return 4+G.upgrades.bag*2;}
function invCount(){return G.inventory.reduce((a,b)=>a+b.qty,0);}

function renderShop(){
  const el=document.getElementById('shopItems');el.innerHTML='';
  G.prices.forEach(p=>{
    const div=document.createElement('div');
    div.className='shop-item'+(G.upgrades.quickBuy?' quick-buy':'');
    div.innerHTML=`<span class="shop-item-icon">${p.icon}</span><span class="shop-item-name">${p.name}</span>
      <span class="shop-item-price">BUY: $${p.buy}</span>
      <button class="buy-btn${G.upgrades.quickBuy?' hidden':''}" data-id="${p.id}">BUY $${p.buy}</button>`;
    if(G.upgrades.quickBuy)div.addEventListener('click',()=>buyItem(p.id));
    el.appendChild(div);
  });
  el.querySelectorAll('.buy-btn').forEach(b=>b.addEventListener('click',()=>buyItem(b.dataset.id)));
  renderInventory();renderCapacity();
  const ct=document.getElementById('comboTray');
  if(G.round>=5)ct.classList.add('show');else ct.classList.remove('show');
  renderComboTray();
  const pp=document.getElementById('powerPanel');
  if(G.round>=3){pp.style.display='block';renderPowers();}else pp.style.display='none';
}

function buyItem(id){
  if(!G.active){setStatus('‚ö† Round not active!');return;}
  const p=G.prices.find(x=>x.id===id);if(!p)return;
  if(G.cash<p.buy){setStatus('‚ö† Not enough cash!');return;}
  if(invCount()>=maxSlots()){setStatus('‚ö† Bag full!');return;}
  G.cash-=p.buy;
  const ex=G.inventory.find(x=>x.id===id);
  if(ex)ex.qty++;else G.inventory.push({...p,qty:1});
  updateHUD();renderInventory();renderCapacity();
  sfx('buy');
  setStatus(`‚úì Bought ${p.icon} ${p.name} for $${p.buy}`);
  if(T.active)tutPhaseCheck('buy');
}

function renderInventory(){
  const el=document.getElementById('inventorySlots');
  if(!G.inventory.length){el.innerHTML='<div class="inv-empty">Empty</div>';return;}
  el.innerHTML='';
  G.inventory.forEach(item=>{
    const div=document.createElement('div');
    div.className='inv-slot';
    div.draggable=true;
    div.dataset.id=item.id;
    const isTCube=item.id==='timecube';
    div.style.cssText=isTCube?'border-color:cyan;background:#001122;box-shadow:0 0 8px cyan;':'';
    div.innerHTML=`<span class="inv-slot-icon">${item.icon}</span><div><span class="inv-slot-name">${item.name}</span><span class="inv-slot-qty">x${item.qty}</span></div>`;
    // Drag always works for single-item delivery
    div.addEventListener('dragstart',e=>onDragStart(e,item.id));
    div.addEventListener('dragend',onDragEnd);
    // Click-to-stage: only in round 5+ and only when the round is active
    // Use mousedown to set a flag, and only trigger addToCombo if it was a click (not a drag)
    if(G.round>=5 && !isTCube){
      div.title='Click to add to SET staging';
      div.style.cursor='pointer';
      let isDragging=false;
      div.addEventListener('mousedown',()=>{isDragging=false;});
      div.addEventListener('dragstart',()=>{isDragging=true;},true);
      div.addEventListener('click',()=>{if(!isDragging)addToCombo(item.id);});
    }
    if(isTCube && G.timeCubes>=3){
      div.title='Click to add to 3-Cube set';
      div.style.cursor='pointer';
      let isDragging2=false;
      div.addEventListener('mousedown',()=>{isDragging2=false;});
      div.addEventListener('dragstart',()=>{isDragging2=true;},true);
      div.addEventListener('click',()=>{if(!isDragging2)addTimeCubeToCombo();});
    }
    el.appendChild(div);
  });
}
function renderCapacity(){
  const el=document.getElementById('capacityBar'),slots=maxSlots(),used=invCount();el.innerHTML='';
  for(let i=0;i<slots;i++){const s=document.createElement('div');s.className='cap-slot'+(i<used?' used':'');el.appendChild(s);}
}

function renderComboTray(){
  const el=document.getElementById('comboSlots');el.innerHTML='';
  // Show 3 staging slots
  for(let i=0;i<3;i++){
    const s=document.createElement('div');
    s.className='combo-slot'+(G.combo[i]?' filled':'');
    s.textContent=G.combo[i]?G.combo[i].icon:'';
    if(G.combo[i])s.addEventListener('click',()=>{G.combo.splice(i,1);renderComboTray();sfx('click');});
    el.appendChild(s);
  }
  // Enable create button only if 2-3 items staged
  const makeBtn=document.getElementById('comboMakeBtn');
  if(makeBtn)makeBtn.disabled=G.combo.length<2;
  renderSetBoxes();
}
function renderSetBoxes(){
  const el=document.getElementById('setBoxes');if(!el)return;
  el.innerHTML='';
  G.sets.forEach((set,idx)=>{
    const box=document.createElement('div');
    box.className='set-box';box.draggable=true;box.dataset.setIdx=idx;
    const label=document.createElement('span');label.className='set-box-label';
    label.textContent=set.items.map(i=>i.icon).join('+');
    const discard=document.createElement('button');
    discard.className='set-box-discard';discard.textContent='‚úï';
    discard.addEventListener('click',(e)=>{
      e.stopPropagation();
      // Return items to inventory
      set.items.forEach(item=>{
        const ex=G.inventory.find(x=>x.id===item.id);
        if(ex)ex.qty++;else G.inventory.push({...item,qty:1});
      });
      G.sets.splice(idx,1);
      sfx('click');renderInventory();renderCapacity();renderComboTray();
      setStatus('Set discarded ‚Äî items returned to inventory.');
    });
    box.appendChild(label);box.appendChild(discard);
    box.addEventListener('dragstart',e=>onDragStartSet(e,idx));
    box.addEventListener('dragend',onDragEnd);
    el.appendChild(box);
  });
  // Max 2 sets label
  if(G.sets.length>=2){
    const full=document.createElement('div');
    full.style.cssText='font-family:"VT323",monospace;font-size:12px;color:var(--accent);text-align:center;margin-top:3px;';
    full.textContent='MAX 2 SETS';el.appendChild(full);
  }
}
function addToCombo(id){
  if(G.combo.length>=3){setStatus('‚ö† Staging full (max 3). Click CREATE SET or clear first.');return;}
  const p=G.prices.find(x=>x.id===id);if(!p)return;
  const inv=G.inventory.find(x=>x.id===id);if(!inv||inv.qty<=0)return;
  // Consume from inventory immediately into staging
  inv.qty--;if(inv.qty<=0)G.inventory=G.inventory.filter(x=>x.qty>0);
  G.combo.push({...p});
  sfx('add');
  renderInventory();renderCapacity();renderComboTray();
  setStatus(`Added ${p.icon} to staging (${G.combo.length}/3). Hit CREATE SET when ready.`);
}
function createSet(){
  // Triple Time Cube secret ending check
  if(G.combo.length===3&&G.combo.filter(x=>x.id==='timecube').length===3){
    G.combo=[];renderComboTray();
    setTimeout(()=>triggerSecretEnding(),300);
    return;
  }
  if(G.combo.length<2){setStatus('‚ö† Need at least 2 items for a set!');return;}
  if(G.sets.length>=2){setStatus('‚ö† Max 2 sets at a time! Deliver or discard one first.');return;}
  const payout=G.combo.reduce((a,p)=>a+getSellPrice(p),0);
  G.sets.push({items:[...G.combo],payout});
  G.combo=[];
  sfx('create');
  renderComboTray();
  setStatus(`‚úì Set created! Drag the green box to deliver.`);
}
document.getElementById('comboMakeBtn').addEventListener('click',()=>createSet());
document.getElementById('comboClear').addEventListener('click',()=>{
  // Return staged items to inventory
  G.combo.forEach(item=>{
    const ex=G.inventory.find(x=>x.id===item.id);
    if(ex)ex.qty++;else G.inventory.push({...item,qty:1});
  });
  G.combo=[];sfx('click');renderInventory();renderCapacity();renderComboTray();
  setStatus('Staging cleared ‚Äî items returned to inventory.');
});

function buildMap(){
  const area=document.getElementById('mapArea'),c=document.getElementById('mapCanvas');
  c.width=area.clientWidth;c.height=area.clientHeight;
  const ctx=c.getContext('2d'),W=c.width,H=c.height;
  ctx.fillStyle='#080812';ctx.fillRect(0,0,W,H);
  [{type:'h',pos:.42},{type:'h',pos:.70},{type:'v',pos:.26},{type:'v',pos:.52},{type:'v',pos:.78}].forEach(r=>{
    if(r.type==='h'){
      const y=r.pos*H;ctx.fillStyle='#12122a';ctx.fillRect(0,y-20,W,40);
      ctx.fillStyle='#1e1e44';ctx.fillRect(0,y-2,W,4);
      for(let x=0;x<W;x+=56){ctx.fillStyle='#f7c94818';ctx.fillRect(x,y-2,28,4);}
    }else{
      const x=r.pos*W;ctx.fillStyle='#12122a';ctx.fillRect(x-16,0,32,H);
      ctx.fillStyle='#1e1e44';ctx.fillRect(x-2,0,4,H);
      for(let y=0;y<H;y+=56){ctx.fillStyle='#f7c94818';ctx.fillRect(x-2,y,4,28);}
    }
  });
  ctx.strokeStyle='#0f0f20';ctx.lineWidth=1;
  for(let x=0;x<W;x+=40){ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,H);ctx.stroke();}
  for(let y=0;y<H;y+=40){ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(W,y);ctx.stroke();}
  const bEl=document.getElementById('mapBuildings');bEl.innerHTML='';
  visibleBuildings().forEach(b=>{
    const bx=b.cx*W-b.w/2,by=b.cy*H;
    const wrap=document.createElement('div');wrap.className='building';wrap.id='b-'+b.id;
    wrap.style.cssText=`left:${bx}px;top:${by}px;width:${b.w}px;`;
    wrap.innerHTML=`<div id="bb-${b.id}" class="bsvg">${buildingPixelArt(b)}</div><div class="building-label">${b.name}</div>`;
    wrap.addEventListener('dragover',e=>{e.preventDefault();wrap.classList.add('drop-target');});
    wrap.addEventListener('dragleave',()=>wrap.classList.remove('drop-target'));
    wrap.addEventListener('drop',e=>onDrop(e,b.id));
    bEl.appendChild(wrap);
  });
  const rider=document.getElementById('mapRider');
  rider.style.left=(W*.5-13)+'px';rider.style.top=(H*.82-13)+'px';
}
function visibleBuildings(){
  return BUILDINGS.filter(b=>{
    if(b.vipOnly&&!G.upgrades.vip)return false;
    if(b.lateOnly&&G.round<4)return false;
    return true;
  });
}
function buildingPixelArt(b){
  const w=b.w,h=b.h,rows=Math.floor(h/13),cols=Math.floor(w/13);let wins='';
  for(let r=1;r<rows-1;r++)for(let c=1;c<cols-1;c++){
    if(Math.random()>.42){const lit=Math.random()>.38;
      wins+=`<rect x="${c*13+2}" y="${r*13+2}" width="8" height="8" fill="${lit?b.accent:'#060610'}" opacity="${lit?.85:.5}"/>`;}
  }
  return `<svg width="${w}" height="${h}" viewBox="0 0 ${w} ${h}" style="image-rendering:pixelated;display:block;">
    <rect width="${w}" height="${h}" fill="${b.color}"/>
    <rect x="0" y="0" width="${w}" height="5" fill="${b.accent}" opacity=".6"/>${wins}
    <rect x="${w/2-7}" y="0" width="14" height="9" fill="${b.accent}" opacity=".7"/>
    <rect x="${w*.18}" y="${h-14}" width="${w*.64}" height="14" fill="${b.accent}" opacity=".25"/>
    <rect x="0" y="${h-3}" width="${w}" height="3" fill="${b.accent}" opacity=".7"/>
    <text x="${w/2}" y="${h/2+5}" text-anchor="middle" font-size="16" fill="${b.accent}" opacity=".15" font-family="monospace">$</text></svg>`;
}

function spawnOrders(){
  const vis=visibleBuildings();
  const base=G.round>=4?Math.min(vis.length,3+Math.floor(Math.random()*2)):2+Math.floor(Math.random()*2);
  const count=G.activePowers.moreDemand?Math.min(vis.length,base+2):base;
  [...vis].sort(()=>Math.random()-.5).slice(0,count).forEach(b=>{
    if(G.orders[b.id])return;
    if(G.round>=5){
      // ~40% chance of a set order, 60% single item ‚Äî so players can still deliver normally
      if(Math.random()<0.4){
        const setSize=2+Math.floor(Math.random()*2); // 2 or 3 items only
        const items=[];for(let i=0;i<setSize;i++)items.push(G.prices[Math.floor(Math.random()*G.prices.length)]);
        const payout=items.reduce((a,p)=>a+getSellPrice(p),0)+(b.vipOnly?12:0);
        G.orders[b.id]={type:'set',items,payout,createdAt:Date.now()};
      }else{
        const p=G.prices[Math.floor(Math.random()*G.prices.length)];
        const payout=getSellPrice(p)+(b.vipOnly?10:0);
        G.orders[b.id]={type:'single',product:p,payout,createdAt:Date.now()};
      }
    }else{
      const p=G.prices[Math.floor(Math.random()*G.prices.length)];
      const payout=getSellPrice(p)+(b.vipOnly?10:0);
      G.orders[b.id]={type:'single',product:p,payout,createdAt:Date.now()};
    }
    addOrderBubble(b);
    if(G.round>=4){
      const waitMs=8000+Math.random()*5000;
      G.orderTimers[b.id]=setTimeout(()=>expireOrder(b.id),waitMs);
      startOrderCountdown(b.id,waitMs);
    }
  });
}

function expireOrder(bid){
  if(!G.orders[bid])return;
  delete G.orders[bid];clearBubble(bid);G.impatientExpired++;
  const bEl=document.getElementById('b-'+bid);
  if(bEl){bEl.classList.add('impatient');setTimeout(()=>bEl.classList.remove('impatient'),800);}
  sfx('impatient');
  setStatus(`üò§ ${BUILDINGS.find(b=>b.id===bid)?.name||bid} got impatient and left!`);
}

function startOrderCountdown(bid,totalMs){
  const start=Date.now();
  const tick=setInterval(()=>{
    if(!G.orders[bid]){clearInterval(tick);return;}
    const pct=Math.max(0,1-(Date.now()-start)/totalMs);
    const fill=document.getElementById('b-'+bid)?.querySelector('.order-timer-fill');
    if(fill){fill.style.width=(pct*100)+'%';fill.style.background=pct>.5?'var(--green)':pct>.2?'var(--accent)':'var(--red)';}
    if(pct<=0)clearInterval(tick);
  },100);
}

function addOrderBubble(b){
  const bEl=document.getElementById('b-'+b.id);if(!bEl)return;
  bEl.querySelectorAll('.order-bubble').forEach(x=>x.remove());
  const order=G.orders[b.id];
  const bub=document.createElement('div');bub.className='order-bubble';bub.style.cssText='top:-50px;left:50%';
  const timerHtml=G.round>=4?'<div class="order-timer-bar"><div class="order-timer-fill" style="width:100%"></div></div>':'';
  if(order.type==='set'){
    bub.innerHTML=`${order.items.map(i=>i.icon).join('+')} <span style="color:var(--green)">$${order.payout}</span>${timerHtml}`;
  }else{
    bub.innerHTML=`${order.product.icon} <span style="color:var(--green)">$${order.payout}</span>${timerHtml}`;
  }
  bEl.style.position='relative';bEl.appendChild(bub);
}
function clearBubble(bid){
  document.getElementById('b-'+bid)?.querySelectorAll('.order-bubble').forEach(x=>x.remove());
  clearTimeout(G.orderTimers[bid]);delete G.orderTimers[bid];
}

let dragging=null,draggingSet=null;
const ghost=document.getElementById('dragGhost');
function onDragStart(e,id){
  if(!G.active){e.preventDefault();return;}
  dragging=id;draggingSet=null;
  ghost.textContent=G.inventory.find(x=>x.id===id)?.icon||'üì¶';ghost.style.display='block';
  e.dataTransfer.effectAllowed='move';e.dataTransfer.setData('text/plain','item:'+id);
}
function onDragStartSet(e,idx){
  if(!G.active){e.preventDefault();return;}
  draggingSet=idx;dragging=null;
  const set=G.sets[idx];
  ghost.textContent=set?set.items.map(i=>i.icon).join('+'):'üì¶';ghost.style.display='block';
  e.dataTransfer.effectAllowed='move';e.dataTransfer.setData('text/plain','set:'+idx);
}
document.addEventListener('dragover',e=>{ghost.style.left=e.clientX+'px';ghost.style.top=e.clientY+'px';});
function onDragEnd(){ghost.style.display='none';dragging=null;document.querySelectorAll('.building').forEach(b=>b.classList.remove('drop-target'));}
function onDrop(e,bid){
  e.preventDefault();document.getElementById('b-'+bid)?.classList.remove('drop-target');
  const raw=e.dataTransfer.getData('text/plain');
  if(raw.startsWith('set:')){
    const idx=parseInt(raw.split(':')[1]);
    deliverSet(isNaN(idx)?draggingSet:idx,bid);
  } else {
    const id=raw.replace('item:','')||dragging;
    if(id)deliverItem(id,bid);
  }
}

function deliverSet(setIdx,bid){
  if(!G.active){setStatus('‚ö† Round not active!');return;}
  const order=G.orders[bid];if(!order||order.type!=='set'){setStatus('‚ö† That building wants a single item, not a set!');return;}
  const set=G.sets[setIdx];if(!set){setStatus('‚ö† Set not found!');return;}
  const needed=[...order.items.map(i=>i.id)].sort().join(',');
  const provided=[...set.items.map(i=>i.id)].sort().join(',');
  if(needed!==provided){
    setStatus(`‚ö† Wrong set! They want: ${order.items.map(i=>i.icon).join('+')} ‚Äî yours: ${set.items.map(i=>i.icon).join('+')}`);
    return;
  }
  // Items were already consumed when staging, so just remove the set box
  G.sets.splice(setIdx,1);
  const earned=order.payout;
  G.cash+=earned;G.profit+=earned;G.deliveries++;G.combos++;
  delete G.orders[bid];clearBubble(bid);
  moveRider(bid);spawnCoinPop(bid,earned);
  sfx('deliver');
  updateHUD();renderInventory();renderCapacity();renderComboTray();
  setStatus(`‚úì SET delivered to ${BUILDINGS.find(b=>b.id===bid)?.name}! +$${earned} üéÅ`);
  setTimeout(()=>{if(G.active)spawnOrders();},2500+Math.random()*3000);
  if(T.active)tutPhaseCheck('setDelivered');
}

function deliverItem(id,bid){
  if(!G.active){setStatus('‚ö† Round not active!');return;}
  const order=G.orders[bid];if(!order){setStatus('‚ö† No order here right now!');return;}
  if(order.type==='set'){
    setStatus('‚ö† They want a SET! Build one in the SET section and drag the green box here.');
    return;
  }
  // Single item delivery ‚Äî check for Time Cube
  if(id==='timecube'){
    const inv=G.inventory.find(x=>x.id==='timecube');
    if(inv){inv.qty--;if(inv.qty<=0)G.inventory=G.inventory.filter(x=>x.qty>0);}
    G.timeCubes=Math.max(0,G.timeCubes-1);
    delete G.orders[bid];clearBubble(bid);
    renderInventory();
    setTimeout(()=>triggerTimeCubeDelivery(),200);
    return;
  }
  if(order.product.id!==id){setStatus(`‚ö† They want ${order.product.icon}! Check the bubble.`);return;}
  const inv=G.inventory.find(x=>x.id===id);if(!inv){setStatus('‚ö† Not in inventory!');return;}
  inv.qty--;if(inv.qty<=0)G.inventory=G.inventory.filter(x=>x.qty>0);
  const earned=order.payout;
  G.cash+=earned;G.profit+=(earned-order.product.buy);G.deliveries++;
  delete G.orders[bid];clearBubble(bid);
  moveRider(bid);spawnCoinPop(bid,earned);
  sfx('deliver');
  updateHUD();renderInventory();renderCapacity();
  setStatus(`‚úì Delivered ${order.product.icon} to ${BUILDINGS.find(b=>b.id===bid)?.name}! +$${earned}`);
  setTimeout(()=>{if(G.active)spawnOrders();},2500+Math.random()*3000);
  if(T.active)tutPhaseCheck('delivery');
}

function spawnCoinPop(bid,amount){
  const bEl=document.getElementById('b-'+bid);if(!bEl)return;
  const r=bEl.getBoundingClientRect();
  const pop=document.createElement('div');pop.className='coin-pop';
  pop.style.cssText=`left:${r.left+r.width/2}px;top:${r.top+10}px;color:var(--green);`;
  pop.textContent=`+$${amount}`;document.body.appendChild(pop);setTimeout(()=>pop.remove(),900);
}
function moveRider(bid){
  const bEl=document.getElementById('b-'+bid),area=document.getElementById('mapArea');
  if(!bEl||!area)return;
  const br=bEl.getBoundingClientRect(),mr=area.getBoundingClientRect();
  const rider=document.getElementById('mapRider');
  rider.style.left=(br.left-mr.left+br.width/2-13)+'px';rider.style.top=(br.top-mr.top+br.height-13)+'px';
  const c=document.getElementById('mapCanvas');
  setTimeout(()=>{rider.style.left=(c.width*.5-13)+'px';rider.style.top=(c.height*.82-13)+'px';},1600);
}

function renderPowers(){
  const el=document.getElementById('powerButtons');el.innerHTML='';
  POWERS.forEach(pw=>{
    if(pw.id==='timeCube'){
      if(!G.timeCubeUnlocked||G.tutMode)return; // never in tutorial, only after threshold
      const tc=document.createElement('div');
      tc.style.cssText='border:2px solid cyan;background:#001122;padding:6px;margin-bottom:4px;cursor:pointer;text-align:center;';
      const tcCanvas=document.createElement('canvas');tcCanvas.width=50;tcCanvas.height=50;
      tcCanvas.style.cssText='display:block;margin:0 auto 4px;';
      tc.appendChild(tcCanvas);
      const label=document.createElement('div');
      label.style.cssText='font-family:"Press Start 2P",monospace;font-size:6px;color:cyan;line-height:1.5;';
      label.innerHTML='TIME CUBE<br><span style="color:#0088aa">$888</span>';
      tc.appendChild(label);
      tc.addEventListener('click',()=>showTimeCubeModal());
      el.appendChild(tc);
      drawTimeCubeIcon(tcCanvas);
      return;
    }
    const isQuickBuyOwned=pw.oneTime&&pw.id==='quickBuy'&&G.upgrades.quickBuy;
    const isActive=G.activePowers[pw.id];
    const btn=document.createElement('button');
    btn.className='power-btn'+(isActive?' active-power':'');
    btn.disabled=G.cash<pw.cost||isQuickBuyOwned||isActive;
    if(isQuickBuyOwned){
      btn.innerHTML=`${pw.icon} ${pw.name}<span class="pcost" style="color:var(--green)">‚úì ACTIVE PERM</span><span class="pdesc">${pw.desc}</span>`;
    }else{
      btn.innerHTML=`${pw.icon} ${pw.name}<span class="pcost">$${pw.cost}${pw.oneTime?' (PERM)':''}</span><span class="pdesc">${pw.desc}</span>`;
    }
    btn.addEventListener('click',()=>activatePower(pw));
    el.appendChild(btn);
  });
}
function activatePower(pw){
  if(!G.active){setStatus('‚ö† Round not active!');return;}
  if(G.cash<pw.cost){setStatus('‚ö† Not enough cash for this power!');return;}
  G.cash-=pw.cost;updateHUD();
  if(pw.id==='priceUp'){
    G.activePowers.priceUp=true;renderMarket();
    setTimeout(()=>{G.activePowers.priceUp=false;renderMarket();renderPowers();},pw.duration);
  }else if(pw.id==='moreDemand'){
    G.activePowers.moreDemand=true;spawnOrders();spawnOrders();
    setTimeout(()=>{G.activePowers.moreDemand=false;renderPowers();},pw.duration);
  }else if(pw.id==='quickBuy'){
    G.upgrades.quickBuy=true;renderShop();
  }
  const flash=document.createElement('div');flash.className='power-flash';
  flash.style.borderColor=pw.id==='priceUp'?'gold':pw.id==='moreDemand'?'#cc88ff':'var(--green)';
  document.body.appendChild(flash);setTimeout(()=>flash.remove(),400);
  sfx('power');
  setStatus(`‚ö° ${pw.name} activated!`);
  renderPowers();
}

function startTimer(){
  G.timeLeft=ROUND_TIME;clearInterval(G.timer);
  G.timer=setInterval(()=>{
    if(T.paused)return; // tutorial is pausing time
    G.timeLeft=Math.max(0,G.timeLeft-.1);
    const pct=(G.timeLeft/ROUND_TIME)*100;
    const bar=document.getElementById('timerBar');
    const col=pct>50?'var(--green)':pct>20?'var(--accent)':'var(--red)';
    bar.style.width=pct+'%';bar.style.background=col;bar.style.boxShadow=`0 0 8px ${col}`;
    if(G.timeLeft<=0){clearInterval(G.timer);G.timer=null;endRound();}
  },100);
}

function showRoundScreen(){
  const nextR=G.round+1;
  document.getElementById('rTitle').textContent=G.round===0?'GET READY!':`ROUND ${nextR}`;
  document.getElementById('rSubtitle').textContent=
    G.round===0?'Wall Street is HUNGRY!':`Profit so far: $${G.profit}`;
  const ev=EVENTS[Math.floor(Math.random()*EVENTS.length)];
  G.event=ev;initPrices(ev);
  document.getElementById('rEventText').innerHTML=ev.text.replace(/\n/g,'<br>');
  const infoBox=document.getElementById('rInfoBox'),infoEl=document.getElementById('rInfoText');
  let msg='';
  if(nextR===4)msg='üÜï Customers now have <strong>timers</strong> ‚Äî deliver before they leave! Two new buildings unlock!';
  if(nextR===5)msg='üÜï Customers order <strong>SETS</strong> of food! Click items in inventory to stage them, press <strong>CREATE SET</strong> to make a draggable box, then drag it to the building. ‚ö° POWERS also available!';
  if(msg){infoBox.style.display='block';infoEl.innerHTML=msg;}else infoBox.style.display='none';
  document.getElementById('roundScreen').classList.add('active');
}
function startRound(){
  document.getElementById('roundScreen').classList.remove('active');
  G.round++;G.active=true;G.orders={};
  Object.values(G.orderTimers).forEach(t=>clearTimeout(t));G.orderTimers={};
  document.querySelectorAll('.order-bubble').forEach(b=>b.remove());
  updateHUD();renderMarket();renderShop();buildMap();spawnOrders();
  [8000,16000,28000,42000].forEach(t=>setTimeout(()=>{if(G.active)spawnOrders();},t));
  startTimer();
  sfx('roundStart');
  let statusMsg=`Round ${G.round} ‚Äî Drag items to deliver!`;
  if(G.round>=5)statusMsg+=' Click items to BUILD SETS!';
  if(G.round>=4)statusMsg+=' Watch order timers!';
  setStatus(statusMsg);
  if(T.active)tutPhaseCheck('roundStart');
}

function endRound(){
  G.active=false;clearInterval(G.timer);G.orders={};
  Object.values(G.orderTimers).forEach(t=>clearTimeout(t));G.orderTimers={};
  document.querySelectorAll('.order-bubble').forEach(b=>b.remove());
  // Game never ends ‚Äî loop forever until Time Cube
  setTimeout(showRoundScreen,800);
}

function updateHUD(){
  document.getElementById('hudCash').textContent='$'+G.cash;
  const p=G.profit,el=document.getElementById('hudProfit');
  el.textContent=(p>=0?'+':'')+'$'+p;el.className='hud-value '+(p>=0?'green':'red');
  const roundEl=document.getElementById('hudRound');
  if(roundEl) roundEl.textContent=G.round||1;
  ['bike','bag','vip','intel'].forEach(k=>{
    const el=document.getElementById('u'+k);
    if(el)el.className='upg-badge'+(G.upgrades[k]?' on':'');
  });
  // Time Cube unlock at $888
  if(!G.tutMode && !G.timeCubeUnlocked && G.cash>=888){
    G.timeCubeUnlocked=true;
    sfx('timecubeUnlock');
    setTimeout(()=>{renderPowers();},300);
  }
}
function setStatus(m){document.getElementById('statusMsg').textContent=m;}



/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   TUTORIAL ‚Äî new overlay system
   Phases: intro ‚Üí (free play) ‚Üí timers ‚Üí sets ‚Üí powers ‚Üí farewell
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

let T={active:false,paused:false,phase:'idle',waitingFor:null};

// ‚îÄ‚îÄ helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function tutPauseTimer(){T.paused=true;}
function tutResumeTimer(){T.paused=false;}
function tutShowOverlay(){
  document.getElementById('tutOverlay').classList.add('active');
  document.getElementById('tutDark').style.display='block';
}
function tutHideOverlay(){
  document.getElementById('tutOverlay').classList.remove('active');
  document.getElementById('tutCard').style.display='none';
  tutClearHighlight();
}
function tutClearHighlight(){
  document.querySelectorAll('.tut-highlight-el').forEach(el=>{
    el.classList.remove('tut-highlight-el');
    el.style.zIndex='';
    el.style.position='';
  });
}
function tutHighlight(selector){
  tutClearHighlight();
  if(!selector)return;
  const el=typeof selector==='string'
    ?(document.getElementById(selector)||document.querySelector(selector))
    :selector;
  if(!el)return;
  el.classList.add('tut-highlight-el');
  if(!el.style.position||el.style.position==='static')el.style.position='relative';
}

// Show a tutorial card. opts:
//   msg, action, tag, highlight, btnLabel, btnClass, onBtn
//   waitFor: null (btn only) | 'buy' | 'delivery' | 'setCreated' | 'powerUsed' | 'setDelivered'
function tutCard(opts){
  tutShowOverlay();
  const card=document.getElementById('tutCard');
  card.style.display='flex';
  document.getElementById('tutTag').textContent=opts.tag||'TUTORIAL';
  document.getElementById('tutMsg').innerHTML=opts.msg||'';
  document.getElementById('tutAction').textContent=opts.action||'';
  document.getElementById('tutAction').style.display=opts.action?'block':'none';
  // footer button
  const footer=document.getElementById('tutFooter');footer.innerHTML='';
  if(opts.btnLabel!==false){
    const btn=document.createElement('button');
    btn.className='tut-btn '+(opts.btnClass||'');
    btn.textContent=opts.btnLabel||'I UNDERSTAND';
    btn.addEventListener('click',()=>{
      if(opts.onBtn)opts.onBtn();
    });
    footer.appendChild(btn);
  }
  tutHighlight(opts.highlight||null);
  T.waitingFor=opts.waitFor||null;
}

// Called by game events to notify the tutorial
function tutNotify(event,data){
  if(!T.active)return;
  if(T.waitingFor===event){
    T.waitingFor=null;
    if(T._onAction){const fn=T._onAction;T._onAction=null;fn(data);}
  }
}

// Wait for a specific game event, then call fn
function tutWaitFor(event,fn){
  T.waitingFor=event;
  T._onAction=fn;
}

// ‚îÄ‚îÄ PHASE: INTRO (rounds 1-3 basics) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function startTutorial(){
  T.active=true;T.phase='intro';T.paused=false;T.waitingFor=null;T._onAction=null;
  const savedUpg=G.upgrades;
  resetGame();G.upgrades=savedUpg;G.tutMode=true;
  showScreen('gameScreen');
  document.getElementById('tutorialBadge').classList.add('show');
  buildMap();
  showRoundScreen();
  // After player clicks START ROUND ‚Äî detected in startRound via tutPhaseCheck
  setTimeout(()=>tutIntroStep1(),300);
}

function tutIntroStep1(){
  // Step 1: Welcome ‚Äî wait for round to start (player clicks START ROUND on round screen)
  tutCard({
    tag:'STEP 1 ‚Äî WELCOME',
    msg:'Welcome to <strong>DIHLICKVERY!</strong> You\'re a delivery rider on Wall Street. Buy food cheap, sell it for profit. Rounds go on <strong>forever</strong> ‚Äî only you can end it.',
    action:'Click START ROUND on the screen above to begin.',
    btnLabel:false, // no button ‚Äî wait for roundStart
    highlight:null,
  });
  tutWaitFor('roundStart',()=>tutIntroStep2());
}

function tutIntroStep2(){
  // Step 2: Market panel ‚Äî pause timer, explain, button to continue
  tutPauseTimer();
  tutCard({
    tag:'STEP 2 ‚Äî MARKET',
    msg:'This is the <strong>üìà MARKET</strong> panel. It shows every item\'s buy price and sell price. <em>Buy low, sell high</em> ‚Äî that\'s your whole job. Prices change every round.',
    action:'Study the prices. When ready, click continue.',
    highlight:'marketPanel',
    btnLabel:'GOT IT ‚Üí',
    onBtn:()=>tutIntroStep3(),
  });
}

function tutIntroStep3(){
  // Step 3: Shop ‚Äî wait for player to actually buy something
  tutCard({
    tag:'STEP 3 ‚Äî BUY AN ITEM',
    msg:'Now go to the <strong>üè™ SHOP</strong> panel on the left. Click <strong>BUY</strong> on any item. Pick the one with the biggest gap between buy and sell price!',
    action:'Click BUY on any item now.',
    highlight:'shopPanel',
    btnLabel:false,
    waitFor:'buy',
  });
  tutWaitFor('buy',()=>tutIntroStep4());
}

function tutIntroStep4(){
  // Step 4: Inventory ‚Äî show it, button to continue
  tutCard({
    tag:'STEP 4 ‚Äî INVENTORY',
    msg:'The item is now in your <strong>üì¶ Inventory</strong>. The dots at the bottom show your bag capacity. You can hold multiple items before delivering.',
    action:'When ready, continue.',
    highlight:'inventorySlots',
    btnLabel:'GOT IT ‚Üí',
    onBtn:()=>tutIntroStep5(),
  });
}

function tutIntroStep5(){
  // Step 5: Map/delivery ‚Äî wait for actual delivery
  tutResumeTimer();
  tutCard({
    tag:'STEP 5 ‚Äî DELIVER',
    msg:'Look at the <strong>map</strong>. Buildings with speech bubbles have orders. <strong>Drag an item</strong> from your inventory and <strong>drop it</strong> onto the building that wants it.',
    action:'Drag an item ‚Üí drop it onto a matching building!',
    highlight:'mapArea',
    btnLabel:false,
    waitFor:'delivery',
  });
  tutWaitFor('delivery',()=>tutIntroStep6());
}

function tutIntroStep6(){
  // Step 6: After first delivery ‚Äî quick tip, then set free
  tutPauseTimer();
  tutCard({
    tag:'STEP 6 ‚Äî GREAT!',
    msg:'<strong>üéâ Delivered!</strong> Your cash and profit went up. Keep buying and delivering until the round timer runs out ‚Äî then the next round starts automatically.',
    action:'You\'re ready for the basics. Go play!',
    highlight:'hudArea',
    btnLabel:'LET ME PLAY! üõµ',
    btnClass:'green',
    onBtn:()=>{
      tutHideOverlay();
      tutResumeTimer();
      // From here the tutorial is silent until round 4
      T.phase='freeplay';
    },
  });
}

// ‚îÄ‚îÄ PHASE: TIMERS (triggered at start of round 4) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function tutTimerPhase(){
  if(T.phase!=='freeplay')return;
  T.phase='timers';
  tutPauseTimer();
  // Slow-spawn one order with timer so player can see it
  setTimeout(()=>{
    if(G.active)spawnOrders();
  },800);
  tutCard({
    tag:'ROUND 4 ‚Äî TIMERS!',
    msg:'From now on, buildings get <strong>impatient</strong>. Each order shows a <strong>timer bar</strong> below the speech bubble. If it empties before you deliver ‚Äî the customer leaves. <em>Two new buildings</em> also unlocked on the map.',
    action:'Watch the timer bars on the speech bubbles.',
    highlight:'mapArea',
    btnLabel:'I UNDERSTAND',
    onBtn:()=>{
      tutHideOverlay();
      tutResumeTimer();
      T.phase='freeplay';
    },
  });
}

// ‚îÄ‚îÄ PHASE: SETS (triggered at start of round 5) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function tutSetsPhase(){
  if(T.phase!=='freeplay')return;
  T.phase='sets';
  tutPauseTimer();
  tutCard({
    tag:'ROUND 5 ‚Äî SET ORDERS!',
    msg:'Some buildings now want <strong>COMBO SETS</strong> ‚Äî like üçï+ü•§. Here\'s how: <em>(1)</em> Click items in your <strong>Inventory</strong> to stage them in the SET section. <em>(2)</em> Press <strong>CREATE SET</strong>. <em>(3)</em> A green box appears ‚Äî <strong>drag it</strong> to the building that ordered that combo.',
    action:'Try building and delivering a set.',
    highlight:'comboTray',
    btnLabel:false,
    waitFor:'setDelivered',
  });
  tutWaitFor('setDelivered',()=>tutPowersPhase());
}

// ‚îÄ‚îÄ PHASE: POWERS (triggered after set delivered, or round 5 if sets not explained) ‚îÄ
function tutPowersPhase(){
  T.phase='powers';
  tutPauseTimer();
  tutCard({
    tag:'POWERS',
    msg:'The <strong>‚ö° POWERS</strong> panel is available from Round 3. Spend cash to activate: <strong>Price Boost</strong> (+50% sell for 10s), <strong>More Demand</strong> (extra orders for 10s), or <strong>Quick Buy</strong> (click items = instant buy, permanent!).',
    action:'Try using a power, or click continue.',
    highlight:'powerPanel',
    btnLabel:'GOT IT ‚Üí',
    onBtn:()=>tutFarewell(),
  });
}

// ‚îÄ‚îÄ FAREWELL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function tutFarewell(){
  T.phase='farewell';
  tutClearHighlight();
  tutCard({
    tag:'TUTORIAL COMPLETE',
    msg:'This is <strong>tutorial mode</strong>. From now on, you will experience what the main game looks like. However, tutorial mode differs from the main game.<br><br><em>I recommend you return back. Something is waiting for you, but I\'m not sure what it is.</em><br><br>Have fun, user.',
    action:'',
    highlight:null,
    btnLabel:'DISMISS',
    btnClass:'green',
    onBtn:()=>{
      tutHideOverlay();
      tutResumeTimer();
      endTutorial();
    },
  });
}

function endTutorial(){
  T.active=false;T.phase='idle';T.waitingFor=null;T._onAction=null;
  tutHideOverlay();
  document.getElementById('tutorialBadge').classList.remove('show');
  G.tutMode=false;
}

// ‚îÄ‚îÄ PHASE TRIGGER hooks (called from game functions) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function tutPhaseCheck(event,data){
  if(!T.active)return;
  switch(event){
    case 'roundStart':
      if(T.phase==='intro')tutNotify('roundStart',data);
      if(T.phase==='freeplay'&&G.round===4)setTimeout(()=>tutTimerPhase(),600);
      if(T.phase==='freeplay'&&G.round===5)setTimeout(()=>tutSetsPhase(),600);
      break;
    case 'buy':      tutNotify('buy',data);break;
    case 'delivery': tutNotify('delivery',data);break;
    case 'setDelivered': tutNotify('setDelivered',data);break;
  }
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TIME CUBE SYSTEM ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function playClockTick(){
  const ac=getAC();if(!ac)return;
  const t=ac.currentTime;
  // Deep mechanical tick
  const osc=ac.createOscillator(),g=ac.createGain();
  osc.connect(g);g.connect(ac.destination);
  osc.type='square';osc.frequency.setValueAtTime(120,t);osc.frequency.setValueAtTime(80,t+0.04);
  g.gain.setValueAtTime(0.5,t);g.gain.exponentialRampToValueAtTime(0.001,t+0.22);
  osc.start(t);osc.stop(t+0.22);
  // Metallic overtone
  const osc2=ac.createOscillator(),g2=ac.createGain();
  osc2.connect(g2);g2.connect(ac.destination);
  osc2.type='sine';osc2.frequency.setValueAtTime(960,t);osc2.frequency.setValueAtTime(640,t+0.06);
  g2.gain.setValueAtTime(0.18,t);g2.gain.exponentialRampToValueAtTime(0.001,t+0.14);
  osc2.start(t);osc2.stop(t+0.14);
}

function showTimeCubeModal(){
  if(!G.active){setStatus('‚ö† Round not active!');return;}
  if(G.cash<888){setStatus('‚ö† Need $888 to obtain the Time Cube!');return;}
  const existing=document.getElementById('timeCubeIcon');
  existing.innerHTML='';
  const mc=document.createElement('canvas');mc.width=80;mc.height=80;
  existing.appendChild(mc);
  drawTimeCubeIcon(mc);
  document.getElementById('timeCubeModal').classList.add('active');
}

document.getElementById('tcYes').addEventListener('click',()=>{
  document.getElementById('timeCubeModal').classList.remove('active');
  if(!G.active||G.cash<888)return;
  G.cash-=888;G.timeCubes++;
  const tcItem=G.inventory.find(x=>x.id==='timecube');
  if(tcItem)tcItem.qty++;
  else G.inventory.push({id:'timecube',name:'TIME CUBE',icon:'üïê',buy:888,sell:0,baseBuy:888,baseSell:0,qty:1});
  updateHUD();renderInventory();renderCapacity();
  setStatus('üïê Time Cube obtained. Handle with extreme care.');
  renderPowers();
});
document.getElementById('tcNo').addEventListener('click',()=>{
  document.getElementById('timeCubeModal').classList.remove('active');
  setStatus('You chose wisely... for now.');
});

function addTimeCubeToCombo(){
  if(G.timeCubes<3){setStatus('‚ö† You need 3 Time Cubes to form the set!');return;}
  const tcInStaging=G.combo.filter(x=>x.id==='timecube').length;
  if(tcInStaging>=3){setStatus('‚ö† All 3 Time Cubes already staged!');return;}
  if(G.combo.length>=3){setStatus('‚ö† Staging full! Clear first.');return;}
  G.combo.push({id:'timecube',name:'TIME CUBE',icon:'üïê',buy:888,sell:0,baseBuy:888,baseSell:0});
  renderComboTray();
  const count=G.combo.filter(x=>x.id==='timecube').length;
  if(count===3){
    // Enable create set button for the triple cube
    setStatus(`üïê 3 Time Cubes staged! Hit CREATE SET to seal your fate...`);
  } else {
    setStatus(`üïê Time Cube staged (${count}/3). Add all 3 then CREATE SET.`);
  }
}
function triggerTimeCubeDelivery(){
  clearInterval(G.timer);G.active=false;
  Object.values(G.orderTimers).forEach(t=>clearTimeout(t));
  const screen=document.getElementById('ending1Screen');
  screen.style.display='flex';
  const overlay=document.getElementById('e1BlueOverlay');
  let tickCount=0;
  const tickInterval=setInterval(()=>{playClockTick();tickCount++;},900);
  let blueProgress=0;
  // Start eerie ambient drone
  const ac=getAC();
  let droneOsc=null,droneGain=null;
  if(ac){
    droneOsc=ac.createOscillator();droneGain=ac.createGain();
    droneOsc.connect(droneGain);droneGain.connect(ac.destination);
    droneOsc.type='sine';droneOsc.frequency.setValueAtTime(60,ac.currentTime);
    droneOsc.frequency.linearRampToValueAtTime(55,ac.currentTime+6);
    droneGain.gain.setValueAtTime(0,ac.currentTime);
    droneGain.gain.linearRampToValueAtTime(0.3,ac.currentTime+1);
    droneOsc.start(ac.currentTime);
  }
  const blueInterval=setInterval(()=>{
    blueProgress=Math.min(1,blueProgress+0.010);
    overlay.style.opacity=blueProgress;
    if(blueProgress>=1){
      clearInterval(blueInterval);clearInterval(tickInterval);
      if(droneOsc){try{droneGain.gain.linearRampToValueAtTime(0,ac.currentTime+0.5);droneOsc.stop(ac.currentTime+0.6);}catch(e){}}
      const ac2=getAC();if(ac2){
        const bell=ac2.createOscillator(),bg2=ac2.createGain();
        bell.connect(bg2);bg2.connect(ac2.destination);bell.type='sine';
        bell.frequency.setValueAtTime(528,ac2.currentTime);
        bg2.gain.setValueAtTime(0.3,ac2.currentTime);bg2.gain.exponentialRampToValueAtTime(0.001,ac2.currentTime+2.5);
        bell.start(ac2.currentTime);bell.stop(ac2.currentTime+2.5);
      }
      setTimeout(showEnding1Clock,400);
    }
  },60);
}

function showEnding1Clock(){
  const clockEl=document.getElementById('e1Clock');
  clockEl.style.display='block';
  const svg=document.getElementById('e1ClockSvg');
  const cx=110,cy=110,cr=100;
  const romanNums=['XII','I','II','III','IV','V','VI','VII','VIII','IX','X','XI'];
  svg.innerHTML=`
    <circle cx="${cx}" cy="${cy}" r="${cr}" fill="#001133" stroke="cyan" stroke-width="3"/>
    <circle cx="${cx}" cy="${cy}" r="${cr-8}" fill="none" stroke="#003366" stroke-width="1"/>
    ${romanNums.map((r,i)=>{
      const a=(i/12)*Math.PI*2-Math.PI/2;
      return `<text x="${cx+Math.cos(a)*(cr-20)}" y="${cy+Math.sin(a)*(cr-20)}" text-anchor="middle" dominant-baseline="middle" fill="cyan" font-size="11" font-family="serif" font-weight="bold">${r}</text>`;
    }).join('')}
    <line id="e1Hr" x1="${cx}" y1="${cy}" x2="${cx}" y2="${cy-60}" stroke="cyan" stroke-width="4" stroke-linecap="round"/>
    <line id="e1Mn" x1="${cx}" y1="${cy}" x2="${cx}" y2="${cy-80}" stroke="#88eeff" stroke-width="2.5" stroke-linecap="round"/>
    <circle cx="${cx}" cy="${cy}" r="5" fill="cyan"/>`;
  let handAngle=0;
  const handInterval=setInterval(()=>{
    handAngle+=3;
    const hr=document.getElementById('e1Hr'),mn=document.getElementById('e1Mn');
    if(hr){const a=handAngle*.1*Math.PI/180;hr.setAttribute('x2',cx+Math.sin(a)*60);hr.setAttribute('y2',cy-Math.cos(a)*60);}
    if(mn){const a=handAngle*Math.PI/180;mn.setAttribute('x2',cx+Math.sin(a)*80);mn.setAttribute('y2',cy-Math.cos(a)*80);}
  },30);
  setTimeout(()=>{
    clearInterval(handInterval);
    svg.querySelectorAll('*').forEach(el=>{
      if(el.getAttribute('fill')==='cyan')el.setAttribute('fill','#00ff00');
      if(el.getAttribute('stroke')==='cyan')el.setAttribute('stroke','#00ff00');
      if(el.getAttribute('stroke')==='#88eeff')el.setAttribute('stroke','#88ff88');
    });
    const textEl=document.getElementById('e1Text');
    textEl.textContent="You've done a great job. But I'm afraid, your cycle is not over.";
    textEl.style.opacity='1';
    setTimeout(()=>{
      const fade=document.createElement('div');
      fade.style.cssText='position:fixed;inset:0;background:#000;opacity:0;z-index:10000;transition:opacity 0.8s;';
      document.body.appendChild(fade);
      requestAnimationFrame(()=>{fade.style.opacity='1';});
      setTimeout(()=>{
        document.getElementById('ending1Screen').style.display='none';
        document.getElementById('e1Clock').style.display='none';
        document.getElementById('e1BlueOverlay').style.opacity='0';
        document.getElementById('e1Text').style.opacity='0';
        fade.remove();
        resetGame();
        showScreen('menuScreen');
      },1000);
    },5000);
  },1800);
}

function triggerSecretEnding(){
  clearInterval(G.timer);G.active=false;
  Object.values(G.orderTimers).forEach(t=>clearTimeout(t));
  const screen=document.getElementById('ending2Screen');
  screen.style.display='flex';
  const glitch=document.getElementById('e2GlitchOverlay');
  glitch.style.display='block';
  glitch.style.cssText='position:fixed;inset:0;z-index:9501;pointer-events:none;';
  let gCount=0;
  // Noise bursts during glitch
  function glitchNoise(){
    const ac=getAC();if(!ac)return;
    const t=ac.currentTime;
    const osc=ac.createOscillator(),g=ac.createGain();
    osc.connect(g);g.connect(ac.destination);
    osc.type='sawtooth';
    osc.frequency.setValueAtTime(80+Math.random()*400,t);
    osc.frequency.linearRampToValueAtTime(Math.random()*200,t+0.08);
    g.gain.setValueAtTime(0.25,t);g.gain.exponentialRampToValueAtTime(0.001,t+0.1);
    osc.start(t);osc.stop(t+0.1);
  }
  const colors=['#ff0000','#00ff00','#0000ff','#ff00ff','#00ffff','#ffff00','#fff'];
  const gInterval=setInterval(()=>{
    gCount++;
    if(gCount%5===0)glitchNoise();
    const lines=[];
    for(let i=0;i<16;i++){
      const y=Math.random()*window.innerHeight;
      const h=2+Math.random()*10;
      const col=colors[Math.floor(Math.random()*colors.length)];
      const off=Math.random()*80-40;
      lines.push(`<rect x="${off}" y="${y}" width="100%" height="${h}" fill="${col}" opacity="${0.25+Math.random()*.5}"/>`);
    }
    for(let i=0;i<4;i++){
      const y=Math.random()*window.innerHeight;
      const h=8+Math.random()*30;
      lines.push(`<rect x="0" y="${y}" width="100%" height="${h}" fill="#000" opacity="${0.4+Math.random()*.4}"/>`);
    }
    glitch.innerHTML=`<svg style="position:fixed;inset:0;width:100%;height:100%;">${lines.join('')}</svg>`;
    if(gCount>50){clearInterval(gInterval);glitch.style.display='none';showSecretText();}
  },100);
}

function showSecretText(){
  const el=document.getElementById('e2Text');
  const sentences=[
    "Do you realize what you just did?",
    "I don't get your desire.",
    "You came here and ceased everything that existed in this universe.",
    "Tell me user, what do you gain from this?"
  ];
  let idx=0;
  function showNext(){
    if(idx>=sentences.length){
      setTimeout(()=>{el.style.transition='opacity 3s';el.style.opacity='0';},4000);
      return;
    }
    el.style.opacity='0';el.style.transition='opacity 0.6s';
    setTimeout(()=>{
      el.textContent=sentences[idx++];
      el.style.opacity='1';
      setTimeout(showNext,4000);
    },600);
  }
  showNext();
}

function startGame(){
  const savedUpg=G.upgrades;resetGame();G.upgrades=savedUpg;
  showScreen('gameScreen');buildMap();showRoundScreen();
}

document.getElementById('btnPlay').addEventListener('click',startGame);
document.getElementById('btnTutorial').addEventListener('click',startTutorial);
document.getElementById('btnCredits').addEventListener('click',()=>document.getElementById('creditsModal').classList.add('active'));
document.getElementById('closeCredits').addEventListener('click',()=>document.getElementById('creditsModal').classList.remove('active'));
document.getElementById('creditsModal').addEventListener('click',(e)=>{if(e.target===document.getElementById('creditsModal'))document.getElementById('creditsModal').classList.remove('active');});
document.getElementById('honorBtn').addEventListener('click',(e)=>{e.stopPropagation();document.getElementById('honorBubble').classList.toggle('show');});
document.getElementById('btnSandbox').addEventListener('click',()=>{const b=document.getElementById('btnSandbox');b.style.transform='rotate(-3deg)';setTimeout(()=>{b.style.transform='rotate(3deg)';setTimeout(()=>{b.style.transform='';},100);},100);});
document.getElementById('roundStartBtn').addEventListener('click',startRound);
document.getElementById('btnPause').addEventListener('click',()=>{clearInterval(G.timer);Object.values(G.orderTimers).forEach(t=>clearTimeout(t));G.active=false;showScreen('menuScreen');});
document.getElementById('goRetry').addEventListener('click',()=>{document.getElementById('gameoverScreen').classList.remove('active');startGame();});
document.getElementById('goMenu').addEventListener('click',()=>{document.getElementById('gameoverScreen').classList.remove('active');showScreen('menuScreen');});
window.addEventListener('resize',()=>{if(document.getElementById('gameScreen').classList.contains('active'))buildMap();});
</script>
</body>
</html>
