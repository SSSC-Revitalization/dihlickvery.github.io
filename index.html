<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Dihlickvery â€“ Wall Street Hustle</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&family=VT323&display=swap');
:root{--bg:#0d0d1a;--panel:#13132b;--border:#f7c948;--accent:#f7c948;--red:#e8334a;--blue:#3a9bd5;--green:#3ddc84;--white:#f0f0f0;--shadow:#f7c94866;--px:4px;}
*{box-sizing:border-box;margin:0;padding:0;}
body{background:var(--bg);font-family:'Press Start 2P',monospace;min-height:100vh;overflow:hidden;position:relative;}
body::after{content:'';position:fixed;inset:0;pointer-events:none;z-index:9999;background:repeating-linear-gradient(to bottom,transparent 0,transparent 3px,rgba(0,0,0,.15) 3px,rgba(0,0,0,.15) 4px);}
.screen{display:none;position:absolute;inset:0;}.screen.active{display:flex;}
#stars{position:fixed;inset:0;pointer-events:none;z-index:0;}
.star{position:absolute;background:var(--white);animation:twinkle var(--d,2s) infinite alternate;}
@keyframes twinkle{from{opacity:.1}to{opacity:.9}}
.skyline{position:fixed;bottom:0;left:0;right:0;height:160px;z-index:1;pointer-events:none;}.skyline svg{width:100%;height:100%;}
.float-item{position:fixed;font-size:26px;pointer-events:none;z-index:2;animation:floatUp var(--d) linear infinite;opacity:0;}
@keyframes floatUp{0%{transform:translateY(0) rotate(0);opacity:0}10%{opacity:.6}90%{opacity:.4}100%{transform:translateY(-100vh) rotate(360deg);opacity:0}}
#menuScreen{align-items:center;justify-content:center;flex-direction:column;z-index:10;}
.title-card{position:relative;background:var(--panel);border:var(--px) solid var(--border);box-shadow:8px 8px 0 #000,0 0 40px var(--shadow);padding:32px 48px 24px;text-align:center;min-width:520px;}
.title-card::before,.title-card::after{content:'';position:absolute;width:16px;height:16px;background:var(--border);top:-4px;}.title-card::before{left:-4px}.title-card::after{right:-4px}
.game-title{font-size:30px;color:var(--accent);letter-spacing:2px;line-height:1.3;text-shadow:4px 4px 0 var(--red),8px 8px 0 #000,0 0 20px var(--shadow);animation:titlePulse 3s ease-in-out infinite;}
@keyframes titlePulse{0%,100%{text-shadow:4px 4px 0 var(--red),8px 8px 0 #000,0 0 20px var(--shadow)}50%{text-shadow:4px 4px 0 var(--red),8px 8px 0 #000,0 0 40px #f7c94899}}
.subtitle{font-family:'VT323',monospace;font-size:18px;color:var(--blue);margin-top:8px;letter-spacing:3px;animation:blink 1.2s steps(1) infinite;}
@keyframes blink{0%,49%{opacity:1}50%,100%{opacity:0}}
.pixel-divider{width:100%;height:4px;margin:18px 0 0;background:repeating-linear-gradient(to right,var(--border) 0,var(--border) 8px,transparent 8px,transparent 16px);}
.buttons-panel{background:var(--panel);border:var(--px) solid var(--border);border-top:none;box-shadow:8px 8px 0 #000;padding:28px 48px 32px;display:flex;flex-direction:column;gap:14px;width:100%;align-items:center;position:relative;}
.buttons-panel::before,.buttons-panel::after{content:'';position:absolute;width:16px;height:16px;background:var(--border);bottom:-4px;}.buttons-panel::before{left:-4px}.buttons-panel::after{right:-4px}
.px-btn{font-family:'Press Start 2P',monospace;font-size:13px;letter-spacing:1px;cursor:pointer;border:none;outline:none;padding:14px 0;width:300px;text-align:center;position:relative;transition:transform .05s,box-shadow .05s;user-select:none;}
.px-btn:active{transform:translate(4px,4px)!important;box-shadow:none!important;}
.btn-play{background:var(--red);color:#fff;box-shadow:4px 4px 0 #7a0f1f,8px 8px 0 #000;border:var(--px) solid #ff6b7a;border-bottom-color:#7a0f1f;border-right-color:#7a0f1f;animation:playGlow 2s ease-in-out infinite;}
.btn-play:hover{background:#ff4d63;transform:translate(-2px,-2px);}
@keyframes playGlow{0%,100%{box-shadow:4px 4px 0 #7a0f1f,8px 8px 0 #000}50%{box-shadow:4px 4px 0 #7a0f1f,8px 8px 0 #000,0 0 18px #e8334a88}}
.btn-tutorial{background:#1a2a1a;color:var(--green);box-shadow:4px 4px 0 #003310,8px 8px 0 #000;border:var(--px) solid #3ddc84;border-bottom-color:#003310;border-right-color:#003310;}
.btn-tutorial:hover{background:#1e3a1e;transform:translate(-2px,-2px);}
.btn-credits{background:var(--blue);color:#fff;box-shadow:4px 4px 0 #1b567a,8px 8px 0 #000;border:var(--px) solid #7cd4ff;border-bottom-color:#1b567a;border-right-color:#1b567a;}
.btn-credits:hover{background:#5bb8f5;transform:translate(-2px,-2px);}
.btn-sandbox{background:#333355;color:#888899;box-shadow:4px 4px 0 #111122,8px 8px 0 #000;border:var(--px) solid #555577;border-bottom-color:#111122;border-right-color:#111122;cursor:not-allowed;}
.btn-sandbox::after{content:'COMING SOON';position:absolute;top:-10px;right:-10px;background:var(--accent);color:#000;font-size:7px;padding:3px 5px;border:2px solid #000;white-space:nowrap;box-shadow:2px 2px 0 #000;}
.version{font-family:'VT323',monospace;font-size:14px;color:#444466;margin-top:10px;letter-spacing:2px;}
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:1000;align-items:center;justify-content:center;}.modal-overlay.active{display:flex;}
.modal-box{background:var(--panel);border:var(--px) solid var(--border);box-shadow:8px 8px 0 #000,0 0 40px var(--shadow);padding:36px 48px;max-width:480px;width:90%;text-align:center;position:relative;}
.modal-box h2{font-size:16px;color:var(--accent);margin-bottom:20px;text-shadow:3px 3px 0 var(--red);}
.modal-box p{font-family:'VT323',monospace;font-size:20px;color:var(--white);line-height:1.7;margin-bottom:4px;}.modal-box .role{color:var(--blue);font-size:18px;}
.modal-close{margin-top:24px;font-family:'Press Start 2P',monospace;font-size:11px;background:var(--red);color:#fff;border:var(--px) solid #ff6b7a;border-bottom-color:#7a0f1f;border-right-color:#7a0f1f;box-shadow:4px 4px 0 #000;padding:12px 28px;cursor:pointer;}.modal-close:hover{background:#ff4d63;}
.honor-btn{position:absolute;bottom:10px;right:12px;font-family:'Press Start 2P',monospace;font-size:6px;color:#444466;background:transparent;border:1px solid #333355;padding:4px 6px;cursor:pointer;transition:color .15s,border-color .15s;}.honor-btn:hover{color:#8888aa;border-color:#8888aa;}
.honor-bubble{display:none;position:absolute;bottom:34px;right:12px;background:#1e1e3a;border:2px solid var(--accent);box-shadow:3px 3px 0 #000;padding:8px 12px;font-family:'VT323',monospace;font-size:20px;color:var(--accent);white-space:nowrap;z-index:10;}
.honor-bubble::after{content:'';position:absolute;bottom:-8px;right:16px;width:0;height:0;border-left:6px solid transparent;border-right:6px solid transparent;border-top:8px solid var(--accent);}.honor-bubble.show{display:block;}
#gameScreen{flex-direction:column;z-index:10;background:var(--bg);}
#tutorialBadge{display:none;position:absolute;top:8px;right:14px;font-family:'Press Start 2P',monospace;font-size:7px;color:#000;background:var(--green);border:2px solid #1eff88;border-bottom-color:#007733;border-right-color:#007733;box-shadow:2px 2px 0 #000;padding:4px 8px;z-index:25;pointer-events:none;animation:tutBadgePulse 2s ease-in-out infinite;}
@keyframes tutBadgePulse{0%,100%{box-shadow:2px 2px 0 #000}50%{box-shadow:2px 2px 0 #000,0 0 10px #3ddc8488}}
#tutorialBadge.show{display:block;}
.hud{display:flex;align-items:center;justify-content:space-between;background:#0a0a16;border-bottom:3px solid var(--border);padding:10px 18px;gap:10px;flex-shrink:0;position:relative;z-index:20;}
.hud-block{display:flex;flex-direction:column;align-items:center;gap:4px;}.hud-label{font-size:6px;color:#888;letter-spacing:1px;}.hud-value{font-size:13px;color:var(--accent);}.hud-value.green{color:var(--green);}.hud-value.red{color:var(--red);}
.timer-bar-bg{width:180px;height:12px;background:#1a1a30;border:2px solid #333;}.timer-bar-fill{height:100%;background:var(--green);transition:width .1s linear;box-shadow:0 0 8px var(--green);}
.round-pips{display:flex;gap:5px;}.pip{width:11px;height:11px;border:2px solid #444;background:#1a1a30;}.pip.done{background:var(--accent);border-color:var(--accent);box-shadow:0 0 5px var(--accent);}.pip.active{background:var(--red);border-color:var(--red);animation:pipPulse .6s steps(2) infinite;}
@keyframes pipPulse{0%{opacity:1}100%{opacity:.4}}
.game-body{display:flex;flex:1;overflow:hidden;}
.shop-panel{width:190px;background:#0e0e20;border-right:3px solid #1e1e3a;display:flex;flex-direction:column;padding:10px;gap:5px;overflow-y:auto;flex-shrink:0;}
.shop-title{font-size:8px;color:var(--accent);text-align:center;margin-bottom:4px;border-bottom:2px solid #1e1e3a;padding-bottom:6px;}
.shop-item{background:#13132b;border:2px solid #2a2a4e;padding:7px;cursor:pointer;user-select:none;transition:border-color .1s;}.shop-item:hover{border-color:var(--accent);}
.shop-item.quick-buy{border-color:var(--green);cursor:pointer;}
.shop-item-icon{font-size:20px;display:block;text-align:center;margin-bottom:3px;}.shop-item-name{font-size:6px;color:var(--white);text-align:center;display:block;margin-bottom:3px;}.shop-item-price{font-size:7px;color:var(--green);text-align:center;display:block;}
.buy-btn{font-family:'Press Start 2P',monospace;font-size:6px;background:#1e1e3a;color:var(--accent);border:2px solid #333;padding:4px;cursor:pointer;width:100%;margin-top:4px;}.buy-btn:hover{background:#2a2a50;border-color:var(--accent);}.buy-btn.hidden{display:none;}
.inventory-section{margin-top:6px;border-top:2px dashed #1e1e3a;padding-top:6px;}.inv-title{font-size:6px;color:#888;margin-bottom:5px;}
.inv-slot{display:flex;align-items:center;gap:5px;background:#0a0a16;border:2px solid #1a1a2e;padding:4px;margin-bottom:3px;cursor:grab;}.inv-slot:hover{border-color:var(--blue);}
.inv-slot-icon{font-size:15px;}.inv-slot-name{font-size:6px;color:var(--white);display:block;}.inv-slot-qty{font-size:6px;color:var(--green);}
.inv-empty{font-family:'VT323',monospace;font-size:14px;color:#333;text-align:center;padding:6px;}
.combo-tray{margin-top:6px;border-top:2px dashed #3a2a1e;padding-top:6px;display:none;}.combo-tray.show{display:block;}
.combo-title{font-size:6px;color:var(--accent);margin-bottom:4px;}.combo-slots{display:flex;gap:3px;flex-wrap:wrap;}
.combo-slot{width:30px;height:30px;border:2px dashed #3a2a1e;background:#0a0a16;display:flex;align-items:center;justify-content:center;font-size:16px;cursor:pointer;}.combo-slot.filled{border-color:var(--accent);border-style:solid;}
.combo-clear{font-family:'Press Start 2P',monospace;font-size:6px;background:#1a0a0a;color:var(--red);border:1px solid var(--red);padding:3px 5px;cursor:pointer;margin-top:4px;width:100%;}
.map-area{flex:1;position:relative;overflow:hidden;background:#080814;}.map-canvas{position:absolute;inset:0;}
.building{position:absolute;cursor:default;user-select:none;}.building-label{position:absolute;bottom:-22px;left:50%;transform:translateX(-50%);font-family:'VT323',monospace;font-size:12px;color:#777;white-space:nowrap;text-align:center;}
.order-bubble{position:absolute;background:#0d0d20;border:2px solid var(--accent);box-shadow:3px 3px 0 #000,0 0 10px var(--shadow);padding:4px 8px;font-family:'VT323',monospace;font-size:15px;color:var(--white);white-space:nowrap;pointer-events:none;z-index:30;transform:translateX(-50%);animation:bubblePop .2s steps(3) forwards;}
.order-bubble::after{content:'';position:absolute;bottom:-8px;left:50%;transform:translateX(-50%);width:0;height:0;border-left:5px solid transparent;border-right:5px solid transparent;border-top:8px solid var(--accent);}
@keyframes bubblePop{from{transform:translateX(-50%) scale(0)}to{transform:translateX(-50%) scale(1)}}
.order-timer-bar{width:100%;height:3px;background:#1a1a30;margin-top:3px;}.order-timer-fill{height:100%;background:var(--green);transition:width .1s linear;}
.building.drop-target .bsvg{filter:brightness(1.8) drop-shadow(0 0 12px #3ddc84);}
.building.impatient .bsvg{animation:impatientFlash .3s steps(2) infinite;}
@keyframes impatientFlash{0%{filter:brightness(1)}100%{filter:brightness(1.6) hue-rotate(180deg)}}
#mapRider{position:absolute;font-size:26px;z-index:40;pointer-events:none;transition:left .45s ease,top .45s ease;animation:riderBob .35s steps(2) infinite;}
@keyframes riderBob{0%,100%{transform:translateY(0)}50%{transform:translateY(-3px)}}
#dragGhost{position:fixed;pointer-events:none;z-index:9998;font-size:28px;display:none;transform:translate(-50%,-50%);}
.market-panel{width:170px;background:#0e0e20;border-left:3px solid #1e1e3a;display:flex;flex-direction:column;padding:10px;gap:5px;overflow-y:auto;flex-shrink:0;}
.market-title{font-size:8px;color:var(--accent);text-align:center;margin-bottom:4px;border-bottom:2px solid #1e1e3a;padding-bottom:6px;}
.market-row{background:#13132b;border:2px solid #1e1e3a;padding:6px 7px;}.market-row-name{font-size:6px;color:#aaa;margin-bottom:3px;}.market-row-price{font-size:10px;color:var(--green);}
.market-row-price.up::after{content:' \u25b2';color:var(--green);font-size:7px;}.market-row-price.down::after{content:' \u25bc';color:var(--red);font-size:7px;}
.market-event-box{background:#150808;border:2px solid var(--red);padding:7px;margin-top:6px;}.market-event-title{font-size:6px;color:var(--red);margin-bottom:4px;}.market-event-text{font-family:'VT323',monospace;font-size:13px;color:#ff7777;line-height:1.4;}
.power-panel{border-top:2px solid #1e1e3a;padding-top:6px;margin-top:4px;}.power-title{font-size:6px;color:#cc88ff;margin-bottom:4px;}
.power-btn{font-family:'Press Start 2P',monospace;font-size:6px;background:#140820;color:#cc88ff;border:2px solid #4a2a6a;padding:4px 5px;cursor:pointer;width:100%;margin-bottom:3px;text-align:left;line-height:1.4;transition:border-color .1s;}
.power-btn:hover:not(:disabled){border-color:#cc88ff;background:#1e1030;}.power-btn:disabled{opacity:.4;cursor:not-allowed;}
.power-btn.active-power{border-color:var(--green);color:var(--green);background:#0a1a10;}.power-btn .pcost{color:var(--accent);display:block;}.power-btn .pdesc{color:#888;font-size:5px;display:block;margin-top:2px;}
.status-bar{background:#080810;border-top:3px solid #1e1e3a;padding:7px 14px;display:flex;align-items:center;gap:10px;flex-shrink:0;}
.status-msg{font-family:'VT323',monospace;font-size:16px;color:var(--blue);flex:1;}
.capacity-bar{display:flex;gap:3px;}.cap-slot{width:12px;height:12px;border:2px solid #333;background:#0a0a16;}.cap-slot.used{background:var(--blue);border-color:var(--blue);}
.tut-bar{display:none;position:fixed;bottom:0;left:0;right:0;z-index:900;background:#1a0005;border-top:3px solid var(--red);padding:10px 20px;pointer-events:none;align-items:center;gap:16px;}
.tut-bar.show{display:flex;}
.tut-bar-step{font-size:7px;color:var(--red);white-space:nowrap;flex-shrink:0;}
.tut-bar-msg{font-family:'VT323',monospace;font-size:17px;color:var(--white);flex:1;line-height:1.3;}
.tut-bar-msg strong{background:var(--red);color:#fff;padding:1px 4px;}.tut-bar-msg em{background:#8b0000;color:#ffaaaa;padding:1px 3px;font-style:normal;}
.tut-bar-dots{display:flex;gap:4px;flex-shrink:0;}.tut-dot{width:8px;height:8px;border:2px solid #660011;background:transparent;}.tut-dot.done{background:var(--red);border-color:var(--red);}.tut-dot.cur{border-color:var(--red);animation:tutDotPulse .6s steps(2) infinite;}
@keyframes tutDotPulse{0%{opacity:1}100%{opacity:.3}}
.tut-highlight{outline:3px solid var(--red)!important;outline-offset:2px;animation:tutHL 1s ease-in-out infinite;position:relative;z-index:50;}
@keyframes tutHL{0%,100%{box-shadow:0 0 0 2px var(--red),0 0 12px #e8334a66}50%{box-shadow:0 0 0 4px var(--red),0 0 20px #e8334a99}}
.round-screen{position:fixed;inset:0;background:rgba(0,0,0,.93);z-index:500;display:none;align-items:center;justify-content:center;flex-direction:column;gap:14px;}.round-screen.active{display:flex;}
.round-title{font-size:22px;color:var(--accent);text-shadow:4px 4px 0 var(--red);animation:titlePulse 1s ease-in-out infinite;}
.round-subtitle{font-family:'VT323',monospace;font-size:26px;color:var(--white);}
.round-event-box{background:#13132b;border:3px solid var(--red);padding:14px 28px;text-align:center;box-shadow:6px 6px 0 #000;max-width:420px;}.round-event-box .event-head{font-size:8px;color:var(--red);margin-bottom:6px;}.round-event-box p{font-family:'VT323',monospace;font-size:20px;color:#ff8888;line-height:1.5;}
.round-info-box{background:#0a1a0a;border:2px solid var(--green);padding:10px 20px;text-align:center;max-width:420px;}.round-info-box p{font-family:'VT323',monospace;font-size:17px;color:var(--green);line-height:1.5;}
.round-btn{font-family:'Press Start 2P',monospace;font-size:11px;background:var(--green);color:#000;border:var(--px) solid #1eff88;border-bottom-color:#007733;border-right-color:#007733;box-shadow:4px 4px 0 #000;padding:13px 30px;cursor:pointer;}.round-btn:hover{background:#5fffaa;}
.gameover-screen{position:fixed;inset:0;background:rgba(0,0,0,.96);z-index:600;display:none;align-items:center;justify-content:center;flex-direction:column;gap:11px;}.gameover-screen.active{display:flex;}
.gameover-title{font-size:22px;color:var(--red);text-shadow:4px 4px 0 #000;animation:titlePulse 1s infinite;}.gameover-grade{font-size:44px;color:var(--accent);text-shadow:5px 5px 0 var(--red);}
.gameover-stat{font-family:'VT323',monospace;font-size:22px;color:var(--white);}.gameover-stat span{color:var(--accent);}
.upgrades-box{background:#13132b;border:3px solid var(--accent);padding:14px 22px;box-shadow:6px 6px 0 #000;max-width:460px;width:90%;}.upgrades-box h3{font-size:9px;color:var(--accent);text-align:center;margin-bottom:10px;}
.upgrade-row{display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:7px;background:#0a0a16;padding:7px 9px;border:2px solid #1e1e3a;}
.upgrade-info{font-family:'VT323',monospace;font-size:15px;color:var(--white);}.upgrade-info small{font-size:12px;color:#666;display:block;}
.upgrade-buy{font-family:'Press Start 2P',monospace;font-size:7px;padding:5px 8px;background:var(--green);color:#000;border:2px solid #1eff88;border-bottom-color:#007733;border-right-color:#007733;box-shadow:2px 2px 0 #000;cursor:pointer;}
.upgrade-buy:disabled{background:#1a2a1a;color:#446644;cursor:not-allowed;border-color:#223322;}.upgrade-buy:not(:disabled):hover{background:#5fffaa;}
.upgrade-owned{font-family:'VT323',monospace;font-size:13px;color:var(--accent);}
.go-btn{font-family:'Press Start 2P',monospace;font-size:10px;padding:13px 26px;cursor:pointer;border:var(--px) solid;box-shadow:4px 4px 0 #000;margin:4px;}
.go-btn.retry{background:var(--red);color:#fff;border-color:#ff6b7a;border-bottom-color:#7a0f1f;border-right-color:#7a0f1f;}.go-btn.menu{background:var(--blue);color:#fff;border-color:#7cd4ff;border-bottom-color:#1b567a;border-right-color:#1b567a;}.go-btn:hover{filter:brightness(1.2);}
.coin-pop{position:fixed;pointer-events:none;z-index:9990;font-family:'Press Start 2P',monospace;font-size:10px;animation:coinFloat .8s ease-out forwards;}
@keyframes coinFloat{0%{opacity:1;transform:translateY(0)}100%{opacity:0;transform:translateY(-50px)}}
.upg-badge{font-size:13px;opacity:.3;}.upg-badge.on{opacity:1;filter:drop-shadow(0 0 4px gold);}
.power-flash{position:fixed;inset:0;pointer-events:none;z-index:50;border:4px solid gold;animation:pfl .35s ease-out forwards;}
@keyframes pfl{from{opacity:.7}to{opacity:0}}
</style>
</head>
<body>
<div id="stars"></div>
<div class="skyline"><svg viewBox="0 0 1440 160" preserveAspectRatio="none" xmlns="http://www.w3.org/2000/svg">
<rect x="0" y="60" width="60" height="100" fill="#0a0a18"/><rect x="70" y="80" width="80" height="80" fill="#0a0a18"/>
<rect x="160" y="30" width="50" height="130" fill="#0a0a18"/><rect x="175" y="10" width="8" height="20" fill="#0a0a18"/>
<rect x="220" y="70" width="70" height="90" fill="#0a0a18"/><rect x="300" y="50" width="40" height="110" fill="#0a0a18"/>
<rect x="350" y="90" width="90" height="70" fill="#0a0a18"/><rect x="450" y="40" width="55" height="120" fill="#0a0a18"/>
<rect x="465" y="20" width="8" height="22" fill="#f7c948" opacity="0.5"/><rect x="515" y="65" width="70" height="95" fill="#0a0a18"/>
<rect x="595" y="45" width="45" height="115" fill="#0a0a18"/><rect x="650" y="75" width="80" height="85" fill="#0a0a18"/>
<rect x="740" y="55" width="50" height="105" fill="#0a0a18"/><rect x="752" y="35" width="8" height="22" fill="#e8334a" opacity="0.4"/>
<rect x="800" y="80" width="70" height="80" fill="#0a0a18"/><rect x="880" y="35" width="60" height="125" fill="#0a0a18"/>
<rect x="950" y="65" width="80" height="95" fill="#0a0a18"/><rect x="1040" y="50" width="45" height="110" fill="#0a0a18"/>
<rect x="1095" y="70" width="70" height="90" fill="#0a0a18"/><rect x="1175" y="45" width="55" height="115" fill="#0a0a18"/>
<rect x="1240" y="60" width="80" height="100" fill="#0a0a18"/><rect x="1330" y="75" width="60" height="85" fill="#0a0a18"/>
<rect x="165" y="50" width="6" height="6" fill="#f7c948" opacity="0.7"/><rect x="455" y="55" width="6" height="6" fill="#3a9bd5" opacity="0.8"/>
<rect x="600" y="60" width="6" height="6" fill="#e8334a" opacity="0.7"/><rect x="884" y="55" width="6" height="6" fill="#f7c948" opacity="0.8"/>
</svg></div>
<div id="floaters"></div><div id="dragGhost"></div>

<div id="menuScreen" class="screen active">
<div style="display:flex;flex-direction:column;align-items:center;position:relative;z-index:10;">
<div class="title-card">
<div style="margin:0 auto 14px;width:200px;height:96px;">
<svg width="200" height="96" viewBox="0 0 200 96" xmlns="http://www.w3.org/2000/svg" style="image-rendering:pixelated">
<rect x="0" y="74" width="200" height="22" fill="#1a1a2e"/><rect x="0" y="76" width="200" height="2" fill="#2a2a4e"/>
<rect x="10" y="83" width="18" height="4" fill="#f7c948" opacity="0.5"/><rect x="48" y="83" width="18" height="4" fill="#f7c948" opacity="0.5"/>
<rect x="86" y="83" width="18" height="4" fill="#f7c948" opacity="0.5"/><rect x="124" y="83" width="18" height="4" fill="#f7c948" opacity="0.5"/>
<rect x="162" y="83" width="18" height="4" fill="#f7c948" opacity="0.5"/>
<rect x="84" y="52" width="28" height="20" fill="#c0392b"/><rect x="84" y="52" width="28" height="4" fill="#e74c3c"/>
<rect x="93" y="54" width="8" height="8" fill="#f39c12"/>
<rect x="96" y="40" width="10" height="14" fill="#e8334a"/><rect x="95" y="38" width="12" height="4" fill="#ff6b7a"/>
<rect x="99" y="34" width="2" height="6" fill="#aaa"/>
<rect x="70" y="64" width="60" height="6" fill="#f7c948"/><rect x="74" y="58" width="6" height="8" fill="#f7c948"/>
<rect x="118" y="58" width="6" height="8" fill="#f7c948"/>
<rect x="65" y="68" width="14" height="10" fill="#333" rx="2"/><rect x="119" y="68" width="14" height="10" fill="#333" rx="2"/>
<rect x="90" y="42" width="16" height="18" fill="#3a9bd5"/><rect x="92" y="32" width="12" height="12" fill="#fdbcb4"/>
<rect x="90" y="28" width="16" height="10" fill="#e8334a"/><rect x="88" y="34" width="4" height="6" fill="#e8334a"/>
<rect x="10" y="53" width="28" height="2" fill="#f7c948" opacity="0.3"/><rect x="5" y="60" width="38" height="2" fill="#f7c948" opacity="0.2"/>
<circle cx="164" cy="38" r="8" fill="#f7c948" opacity="0.9"/>
<text x="160" y="42" fill="#000" font-size="10" font-family="monospace" font-weight="bold">$</text>
</svg></div>
<div class="game-title">DIHLICKVERY</div>
<div class="subtitle">because it rhymes with DELIVERY!</div>
<div class="pixel-divider"></div></div>
<div class="buttons-panel">
<button class="px-btn btn-play" id="btnPlay">&#127829;  PLAY</button>
<button class="px-btn btn-tutorial" id="btnTutorial">&#10067;  TUTORIAL</button>
<button class="px-btn btn-credits" id="btnCredits">&#128220;  CREDITS</button>
<button class="px-btn btn-sandbox" id="btnSandbox">&#129514;  SANDBOX</button>
<div class="version">VER 0.2.0 &nbsp;|&nbsp; 2025</div>
</div></div></div>

<div class="modal-overlay" id="creditsModal"><div class="modal-box">
<h2>&#128220; CREDITS</h2>
<p>GAME DESIGN &amp; CONCEPT</p><p class="role">&#9733; SSSC &#9733;</p><br>
<p>DEVELOPMENT</p><p class="role">DIHLICKVERY TEAM</p><br>
<p>PIXEL ART &amp; MUSIC</p><p class="role">CALM THE CLAUDE</p><br>
<p>COLLABORATORS</p><p class="role">&#129309; BAITOEY + ICE + GRACE</p><br>
<p>SPECIAL THANKS</p><p class="role">&#129380; COLA &amp; PIZZA &#127829;</p>
<button class="modal-close" id="closeCredits">&#10005; CLOSE</button>
<div class="honor-bubble" id="honorBubble">&gt; Make</div>
<button class="honor-btn" id="honorBtn">HONORABLE<br>MENTION</button>
</div></div>

<div id="gameScreen" class="screen">
<div id="tutorialBadge">&#128214; TUTORIAL MODE</div>
<div class="hud" id="hudArea">
<div class="hud-block"><span class="hud-label">CASH</span><span class="hud-value green" id="hudCash">$60</span></div>
<div class="hud-block"><span class="hud-label">PROFIT</span><span class="hud-value" id="hudProfit">+$0</span></div>
<div class="hud-block"><span class="hud-label">TIME</span><div class="timer-bar-bg"><div class="timer-bar-fill" id="timerBar" style="width:100%"></div></div></div>
<div class="hud-block"><span class="hud-label">ROUNDS</span><div class="round-pips" id="roundPips"></div></div>
<div class="hud-block"><span class="hud-label">TARGET</span><span class="hud-value red" id="hudTarget">$120</span></div>
<div class="hud-block"><span class="hud-label">UPGRADES</span><div style="display:flex;gap:3px;">
<span class="upg-badge" id="ubike">&#128755;</span><span class="upg-badge" id="ubag">&#128230;</span>
<span class="upg-badge" id="uvip">&#11088;</span><span class="upg-badge" id="uintel">&#128202;</span></div></div>
<button id="btnPause" style="font-family:'Press Start 2P',monospace;font-size:8px;background:#1a1a30;color:#888;border:2px solid #333;padding:6px 10px;cursor:pointer;">&#9208;</button>
</div>
<div class="game-body">
<div class="shop-panel" id="shopPanel">
<div class="shop-title">&#127978; SHOP</div><div id="shopItems"></div>
<div class="inventory-section"><div class="inv-title">&#128230; INVENTORY</div><div id="inventorySlots"><div class="inv-empty">Empty</div></div></div>
<div class="combo-tray" id="comboTray"><div class="combo-title">&#127873; BUILD SET</div>
<div class="combo-slots" id="comboSlots"></div>
<button class="combo-clear" id="comboClear">&#10005; CLEAR SET</button></div>
</div>
<div class="map-area" id="mapArea"><canvas id="mapCanvas" class="map-canvas"></canvas><div id="mapBuildings"></div><div id="mapRider">&#128755;</div></div>
<div class="market-panel" id="marketPanel">
<div class="market-title">&#128200; MARKET</div><div id="marketRows"></div>
<div id="marketEventBox" style="display:none;"></div>
<div class="power-panel" id="powerPanel" style="display:none;"><div class="power-title">&#9889; POWERS</div><div id="powerButtons"></div></div>
</div></div>
<div class="status-bar"><span class="status-msg" id="statusMsg">&#9658; BUY items then DRAG to buildings!</span><div class="capacity-bar" id="capacityBar"></div></div>
</div>

<div class="tut-bar" id="tutBar">
<span class="tut-bar-step" id="tutBarStep">STEP 1</span>
<span class="tut-bar-msg" id="tutBarMsg">Welcome!</span>
<div class="tut-bar-dots" id="tutBarDots"></div>
</div>

<div class="round-screen" id="roundScreen">
<div class="round-title" id="rTitle">GET READY!</div>
<div class="round-subtitle" id="rSubtitle">Wall Street is hungry!</div>
<div class="round-event-box"><div class="event-head">&#128240; MARKET NEWS</div><p id="rEventText">Markets are calm.</p></div>
<div class="round-info-box" id="rInfoBox" style="display:none;"><p id="rInfoText"></p></div>
<button class="round-btn" id="roundStartBtn">&#9658; START ROUND</button>
</div>

<div class="gameover-screen" id="gameoverScreen">
<div class="gameover-title" id="goTitle">GAME OVER</div>
<div class="gameover-grade" id="goGrade">C</div>
<div class="gameover-stat">TOTAL PROFIT: <span id="goProfit">$0</span></div>
<div class="gameover-stat">TARGET: <span id="goTarget">$280</span></div>
<div class="gameover-stat">DELIVERIES: <span id="goDeliveries">0</span></div>
<div class="upgrades-box"><h3>&#128295; SPEND YOUR EARNINGS ON UPGRADES</h3><div id="upgradesList"></div></div>
<div style="display:flex;gap:8px;margin-top:6px;">
<button class="go-btn retry" id="goRetry">&#8634; PLAY AGAIN</button>
<button class="go-btn menu" id="goMenu">&#8962; MENU</button>
</div></div>

<script>

/* STARS + FLOATERS */
const starsEl=document.getElementById('stars');
for(let i=0;i<80;i++){
  const s=document.createElement('div');s.className='star';
  s.style.cssText=`left:${Math.random()*100}%;top:${Math.random()*100}%;--d:${1.5+Math.random()*3}s;animation-delay:${Math.random()*3}s;width:${Math.random()>.7?'4px':'2px'};height:${Math.random()>.7?'4px':'2px'};opacity:${.2+Math.random()*.5}`;
  starsEl.appendChild(s);
}
['ðŸ•','ðŸ¥¤','ðŸ’µ','ðŸ’°','ðŸ“¦','ðŸ›µ','â­','ðŸ’²'].forEach((em,i)=>{
  const d=document.createElement('div');d.className='float-item';d.textContent=em;
  d.style.cssText=`left:${5+(i/8)*90}%;--d:${8+Math.random()*10}s;animation-delay:${Math.random()*10}s`;
  document.getElementById('floaters').appendChild(d);
});

const TOTAL_ROUNDS=5,ROUND_TIME=60,BASE_TARGET=120;
const PRODUCTS=[
  {id:'pizza',name:'PIZZA',icon:'ðŸ•',baseBuy:8,baseSell:18},
  {id:'cola',name:'COLA',icon:'ðŸ¥¤',baseBuy:3,baseSell:8},
  {id:'wings',name:'WINGS',icon:'ðŸ—',baseBuy:10,baseSell:22},
  {id:'coffee',name:'COFFEE',icon:'â˜•',baseBuy:4,baseSell:10},
];
const BUILDINGS=[
  {id:'bull',name:'BULL BANK',cx:.13,cy:.22,color:'#0d1f3c',accent:'#3a9bd5',w:68,h:92},
  {id:'bear',name:'BEAR BROKERS',cx:.32,cy:.28,color:'#280e0e',accent:'#e8334a',w:58,h:74},
  {id:'nyse',name:'NYSE TOWER',cx:.52,cy:.12,color:'#22220a',accent:'#f7c948',w:78,h:108},
  {id:'fed',name:'THE FED',cx:.70,cy:.30,color:'#0e201a',accent:'#3ddc84',w:64,h:84},
  {id:'gold',name:'GOLD EXCHANGE',cx:.84,cy:.18,color:'#201808',accent:'#f7c948',w:54,h:68},
  {id:'vip',name:'VIP SUITE â­',cx:.50,cy:.58,color:'#180e28',accent:'#cc88ff',w:72,h:58,vipOnly:true},
  {id:'hedge',name:'HEDGE FUND',cx:.20,cy:.60,color:'#0a1a2a',accent:'#66ccff',w:60,h:70,lateOnly:true},
  {id:'sec',name:'SEC OFFICE',cx:.76,cy:.58,color:'#1a1a0a',accent:'#aadd44',w:56,h:66,lateOnly:true},
];
const EVENTS=[
  {text:'ðŸ“ˆ BULL RUN!\nPizza demand DOUBLED!',fx:p=>{if(p.id==='pizza')p.sell*=2;}},
  {text:'ðŸ“‰ MARKET CRASH!\nCola stress-drinking. Cola +60%!',fx:p=>{if(p.id==='cola')p.sell=Math.floor(p.sell*1.6);}},
  {text:'ðŸŒ¡ï¸ HEAT WAVE!\nCola flying off shelves. Cola x2!',fx:p=>{if(p.id==='cola')p.sell*=2;}},
  {text:'ðŸ’¼ BOARD MEETING!\nCoffee demand sky-high. Coffee x2!',fx:p=>{if(p.id==='coffee')p.sell*=2;}},
  {text:'ðŸ— WING WEDNESDAY!\nEvery floor wants Wings. Wings +80%!',fx:p=>{if(p.id==='wings')p.sell=Math.floor(p.sell*1.8);}},
  {text:'ðŸ˜´ QUIET FRIDAY\nMarkets calm. Standard prices.',fx:()=>{}},
  {text:'ðŸ”” IPO DAY!\nAll prices surge. Everything +35%!',fx:p=>{p.sell=Math.floor(p.sell*1.35);}},
  {text:'ðŸ¦ MERGER MANIA!\nPizza & Wings are HOT. +45% each!',fx:p=>{if(p.id==='pizza'||p.id==='wings')p.sell=Math.floor(p.sell*1.45);}},
];
const POWERS=[
  {id:'priceUp',icon:'ðŸ“ˆ',name:'PRICE BOOST',desc:'All sell prices +50% for 10s',cost:25,duration:10000},
  {id:'moreDemand',icon:'ðŸ™ï¸',name:'MORE DEMAND',desc:'Spawns extra orders for 10s',cost:20,duration:10000},
  {id:'quickBuy',icon:'âš¡',name:'QUICK BUY',desc:'Click item = instant buy (PERM)',cost:35,duration:0,oneTime:true},
];
const UPGRADES_DEF=[
  {key:'bike',icon:'ðŸ›µ',name:'FASTER BIKE',desc:'+speed (visual)',cost:[30,60],max:2},
  {key:'bag',icon:'ðŸ“¦',name:'BIGGER BAG',desc:'+2 inv slots',cost:[40,80],max:2},
  {key:'vip',icon:'â­',name:'VIP ACCESS',desc:'Unlock VIP Suite',cost:[50],max:1},
  {key:'intel',icon:'ðŸ“Š',name:'MARKET INTEL',desc:'Preview next event',cost:[45],max:1},
];

let G={};
function resetGame(){
  const savedUpg=G.upgrades||{bike:0,bag:0,vip:false,intel:false,quickBuy:false};
  G={cash:60,profit:0,round:0,active:false,timeLeft:ROUND_TIME,timer:null,
     inventory:[],orders:{},orderTimers:{},deliveries:0,combos:0,
     upgrades:savedUpg,upgradePoints:0,prices:[],event:null,
     activePowers:{priceUp:false,moreDemand:false},combo:[],impatientExpired:0};
}
resetGame();

function showScreen(id){
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

function initPrices(ev){
  G.prices=PRODUCTS.map(p=>{
    const m={...p};
    m.buy=Math.max(1,m.baseBuy+Math.round((Math.random()-.5)*4));
    m.sell=Math.max(m.buy+2,m.baseSell+Math.round((Math.random()-.5)*6));
    if(ev)ev.fx(m);return m;
  });
}
function getSellPrice(p){return G.activePowers.priceUp?Math.floor(p.sell*1.5):p.sell;}

function renderMarket(){
  const el=document.getElementById('marketRows');el.innerHTML='';
  G.prices.forEach(p=>{
    const div=document.createElement('div');div.className='market-row';
    const sell=getSellPrice(p),trend=p.sell>p.baseSell?'up':p.sell<p.baseSell?'down':'';
    div.innerHTML=`<div class="market-row-name">${p.icon} ${p.name}</div>
      <div class="market-row-price ${trend}">$${p.buy}&#8594;<span style="color:${G.activePowers.priceUp?'#ffcc00':'var(--green)'}">$${sell}</span></div>`;
    el.appendChild(div);
  });
  const evBox=document.getElementById('marketEventBox');
  if(G.event){evBox.style.display='block';evBox.innerHTML=`<div class="market-event-box"><div class="market-event-title">ðŸ“° EVENT</div><div class="market-event-text">${G.event.text.replace(/\n/g,'<br>')}</div></div>`;}
  else evBox.style.display='none';
}

function maxSlots(){return 4+G.upgrades.bag*2;}
function invCount(){return G.inventory.reduce((a,b)=>a+b.qty,0);}

function renderShop(){
  const el=document.getElementById('shopItems');el.innerHTML='';
  G.prices.forEach(p=>{
    const div=document.createElement('div');
    div.className='shop-item'+(G.upgrades.quickBuy?' quick-buy':'');
    div.innerHTML=`<span class="shop-item-icon">${p.icon}</span><span class="shop-item-name">${p.name}</span>
      <span class="shop-item-price">BUY: $${p.buy}</span>
      <button class="buy-btn${G.upgrades.quickBuy?' hidden':''}" data-id="${p.id}">BUY $${p.buy}</button>`;
    if(G.upgrades.quickBuy)div.addEventListener('click',()=>buyItem(p.id));
    el.appendChild(div);
  });
  el.querySelectorAll('.buy-btn').forEach(b=>b.addEventListener('click',()=>buyItem(b.dataset.id)));
  renderInventory();renderCapacity();
  const ct=document.getElementById('comboTray');
  if(G.round>=5)ct.classList.add('show');else ct.classList.remove('show');
  renderComboTray();
  const pp=document.getElementById('powerPanel');
  if(G.round>=3){pp.style.display='block';renderPowers();}else pp.style.display='none';
}

function buyItem(id){
  if(!G.active){setStatus('âš  Round not active!');return;}
  const p=G.prices.find(x=>x.id===id);if(!p)return;
  if(G.cash<p.buy){setStatus('âš  Not enough cash!');return;}
  if(invCount()>=maxSlots()){setStatus('âš  Bag full!');return;}
  G.cash-=p.buy;
  const ex=G.inventory.find(x=>x.id===id);
  if(ex)ex.qty++;else G.inventory.push({...p,qty:1});
  updateHUD();renderInventory();renderCapacity();
  setStatus(`âœ“ Bought ${p.icon} ${p.name} for $${p.buy}`);
  if(T.active&&TUT_STEPS[T.step]?.trigger==='buy')advanceTut();
}

function renderInventory(){
  const el=document.getElementById('inventorySlots');
  if(!G.inventory.length){el.innerHTML='<div class="inv-empty">Empty</div>';return;}
  el.innerHTML='';
  G.inventory.forEach(item=>{
    const div=document.createElement('div');div.className='inv-slot';div.draggable=true;div.dataset.id=item.id;
    div.innerHTML=`<span class="inv-slot-icon">${item.icon}</span><div><span class="inv-slot-name">${item.name}</span><span class="inv-slot-qty">x${item.qty}</span></div>`;
    div.addEventListener('dragstart',e=>onDragStart(e,item.id));
    div.addEventListener('dragend',onDragEnd);
    if(G.round>=5)div.addEventListener('click',()=>addToCombo(item.id));
    el.appendChild(div);
  });
}
function renderCapacity(){
  const el=document.getElementById('capacityBar'),slots=maxSlots(),used=invCount();el.innerHTML='';
  for(let i=0;i<slots;i++){const s=document.createElement('div');s.className='cap-slot'+(i<used?' used':'');el.appendChild(s);}
}

function renderComboTray(){
  const el=document.getElementById('comboSlots');el.innerHTML='';
  for(let i=0;i<3;i++){
    const s=document.createElement('div');
    s.className='combo-slot'+(G.combo[i]?' filled':'');
    s.textContent=G.combo[i]?G.combo[i].icon:'';
    if(G.combo[i])s.addEventListener('click',()=>{G.combo.splice(i,1);renderComboTray();});
    el.appendChild(s);
  }
}
function addToCombo(id){
  if(G.combo.length>=3){setStatus('âš  Set full! Max 3 items. Clear to start over.');return;}
  const p=G.prices.find(x=>x.id===id);if(!p)return;
  const inv=G.inventory.find(x=>x.id===id);if(!inv||inv.qty<=0)return;
  G.combo.push({...p});renderComboTray();
  setStatus(`Added ${p.icon} to set (${G.combo.length}/3). Add more or drag set to a building!`);
}
document.getElementById('comboClear').addEventListener('click',()=>{G.combo=[];renderComboTray();});

function buildMap(){
  const area=document.getElementById('mapArea'),c=document.getElementById('mapCanvas');
  c.width=area.clientWidth;c.height=area.clientHeight;
  const ctx=c.getContext('2d'),W=c.width,H=c.height;
  ctx.fillStyle='#080812';ctx.fillRect(0,0,W,H);
  [{type:'h',pos:.42},{type:'h',pos:.70},{type:'v',pos:.26},{type:'v',pos:.52},{type:'v',pos:.78}].forEach(r=>{
    if(r.type==='h'){
      const y=r.pos*H;ctx.fillStyle='#12122a';ctx.fillRect(0,y-20,W,40);
      ctx.fillStyle='#1e1e44';ctx.fillRect(0,y-2,W,4);
      for(let x=0;x<W;x+=56){ctx.fillStyle='#f7c94818';ctx.fillRect(x,y-2,28,4);}
    }else{
      const x=r.pos*W;ctx.fillStyle='#12122a';ctx.fillRect(x-16,0,32,H);
      ctx.fillStyle='#1e1e44';ctx.fillRect(x-2,0,4,H);
      for(let y=0;y<H;y+=56){ctx.fillStyle='#f7c94818';ctx.fillRect(x-2,y,4,28);}
    }
  });
  ctx.strokeStyle='#0f0f20';ctx.lineWidth=1;
  for(let x=0;x<W;x+=40){ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,H);ctx.stroke();}
  for(let y=0;y<H;y+=40){ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(W,y);ctx.stroke();}
  const bEl=document.getElementById('mapBuildings');bEl.innerHTML='';
  visibleBuildings().forEach(b=>{
    const bx=b.cx*W-b.w/2,by=b.cy*H;
    const wrap=document.createElement('div');wrap.className='building';wrap.id='b-'+b.id;
    wrap.style.cssText=`left:${bx}px;top:${by}px;width:${b.w}px;`;
    wrap.innerHTML=`<div id="bb-${b.id}" class="bsvg">${buildingPixelArt(b)}</div><div class="building-label">${b.name}</div>`;
    wrap.addEventListener('dragover',e=>{e.preventDefault();wrap.classList.add('drop-target');});
    wrap.addEventListener('dragleave',()=>wrap.classList.remove('drop-target'));
    wrap.addEventListener('drop',e=>onDrop(e,b.id));
    bEl.appendChild(wrap);
  });
  const rider=document.getElementById('mapRider');
  rider.style.left=(W*.5-13)+'px';rider.style.top=(H*.82-13)+'px';
}
function visibleBuildings(){
  return BUILDINGS.filter(b=>{
    if(b.vipOnly&&!G.upgrades.vip)return false;
    if(b.lateOnly&&G.round<4)return false;
    return true;
  });
}
function buildingPixelArt(b){
  const w=b.w,h=b.h,rows=Math.floor(h/13),cols=Math.floor(w/13);let wins='';
  for(let r=1;r<rows-1;r++)for(let c=1;c<cols-1;c++){
    if(Math.random()>.42){const lit=Math.random()>.38;
      wins+=`<rect x="${c*13+2}" y="${r*13+2}" width="8" height="8" fill="${lit?b.accent:'#060610'}" opacity="${lit?.85:.5}"/>`;}
  }
  return `<svg width="${w}" height="${h}" viewBox="0 0 ${w} ${h}" style="image-rendering:pixelated;display:block;">
    <rect width="${w}" height="${h}" fill="${b.color}"/>
    <rect x="0" y="0" width="${w}" height="5" fill="${b.accent}" opacity=".6"/>${wins}
    <rect x="${w/2-7}" y="0" width="14" height="9" fill="${b.accent}" opacity=".7"/>
    <rect x="${w*.18}" y="${h-14}" width="${w*.64}" height="14" fill="${b.accent}" opacity=".25"/>
    <rect x="0" y="${h-3}" width="${w}" height="3" fill="${b.accent}" opacity=".7"/>
    <text x="${w/2}" y="${h/2+5}" text-anchor="middle" font-size="16" fill="${b.accent}" opacity=".15" font-family="monospace">$</text></svg>`;
}

function spawnOrders(){
  const vis=visibleBuildings();
  const base=G.round>=4?Math.min(vis.length,3+Math.floor(Math.random()*2)):2+Math.floor(Math.random()*2);
  const count=G.activePowers.moreDemand?Math.min(vis.length,base+2):base;
  [...vis].sort(()=>Math.random()-.5).slice(0,count).forEach(b=>{
    if(G.orders[b.id])return;
    if(G.round>=5){
      const setSize=1+Math.floor(Math.random()*3);
      const items=[];for(let i=0;i<setSize;i++)items.push(G.prices[Math.floor(Math.random()*G.prices.length)]);
      const payout=items.reduce((a,p)=>a+getSellPrice(p),0)+(b.vipOnly?12:0);
      G.orders[b.id]={type:'set',items,payout,createdAt:Date.now()};
    }else{
      const p=G.prices[Math.floor(Math.random()*G.prices.length)];
      const payout=getSellPrice(p)+(b.vipOnly?10:0);
      G.orders[b.id]={type:'single',product:p,payout,createdAt:Date.now()};
    }
    addOrderBubble(b);
    if(G.round>=4){
      const waitMs=8000+Math.random()*5000;
      G.orderTimers[b.id]=setTimeout(()=>expireOrder(b.id),waitMs);
      startOrderCountdown(b.id,waitMs);
    }
  });
}

function expireOrder(bid){
  if(!G.orders[bid])return;
  delete G.orders[bid];clearBubble(bid);G.impatientExpired++;
  const bEl=document.getElementById('b-'+bid);
  if(bEl){bEl.classList.add('impatient');setTimeout(()=>bEl.classList.remove('impatient'),800);}
  setStatus(`ðŸ˜¤ ${BUILDINGS.find(b=>b.id===bid)?.name||bid} got impatient and left!`);
}

function startOrderCountdown(bid,totalMs){
  const start=Date.now();
  const tick=setInterval(()=>{
    if(!G.orders[bid]){clearInterval(tick);return;}
    const pct=Math.max(0,1-(Date.now()-start)/totalMs);
    const fill=document.getElementById('b-'+bid)?.querySelector('.order-timer-fill');
    if(fill){fill.style.width=(pct*100)+'%';fill.style.background=pct>.5?'var(--green)':pct>.2?'var(--accent)':'var(--red)';}
    if(pct<=0)clearInterval(tick);
  },100);
}

function addOrderBubble(b){
  const bEl=document.getElementById('b-'+b.id);if(!bEl)return;
  bEl.querySelectorAll('.order-bubble').forEach(x=>x.remove());
  const order=G.orders[b.id];
  const bub=document.createElement('div');bub.className='order-bubble';bub.style.cssText='top:-50px;left:50%';
  const timerHtml=G.round>=4?'<div class="order-timer-bar"><div class="order-timer-fill" style="width:100%"></div></div>':'';
  if(order.type==='set'){
    bub.innerHTML=`${order.items.map(i=>i.icon).join('+')} <span style="color:var(--green)">$${order.payout}</span>${timerHtml}`;
  }else{
    bub.innerHTML=`${order.product.icon} <span style="color:var(--green)">$${order.payout}</span>${timerHtml}`;
  }
  bEl.style.position='relative';bEl.appendChild(bub);
}
function clearBubble(bid){
  document.getElementById('b-'+bid)?.querySelectorAll('.order-bubble').forEach(x=>x.remove());
  clearTimeout(G.orderTimers[bid]);delete G.orderTimers[bid];
}

let dragging=null;
const ghost=document.getElementById('dragGhost');
function onDragStart(e,id){
  if(!G.active){e.preventDefault();return;}
  dragging=id;ghost.textContent=G.inventory.find(x=>x.id===id)?.icon||'ðŸ“¦';ghost.style.display='block';
  e.dataTransfer.effectAllowed='move';e.dataTransfer.setData('text/plain',id);
}
document.addEventListener('dragover',e=>{ghost.style.left=e.clientX+'px';ghost.style.top=e.clientY+'px';});
function onDragEnd(){ghost.style.display='none';dragging=null;document.querySelectorAll('.building').forEach(b=>b.classList.remove('drop-target'));}
function onDrop(e,bid){
  e.preventDefault();document.getElementById('b-'+bid)?.classList.remove('drop-target');
  const id=e.dataTransfer.getData('text/plain')||dragging;
  if(id)deliverItem(id,bid);
}

function deliverItem(id,bid){
  if(!G.active){setStatus('âš  Round not active!');return;}
  const order=G.orders[bid];if(!order){setStatus('âš  No order here right now!');return;}
  if(order.type==='set'){
    if(G.combo.length===0){setStatus('âš  Build a set first! Click items in inventory to add.');return;}
    const needed=[...order.items.map(i=>i.id)].sort().join(',');
    const provided=[...G.combo.map(i=>i.id)].sort().join(',');
    if(needed!==provided){
      setStatus(`âš  Wrong set! They want: ${order.items.map(i=>i.icon).join('+')} â€” you built: ${G.combo.map(i=>i.icon).join('+')}`);
      return;
    }
    G.combo.forEach(ci=>{
      const inv=G.inventory.find(x=>x.id===ci.id);
      if(inv){inv.qty--;if(inv.qty<=0)G.inventory=G.inventory.filter(x=>x.qty>0);}
    });
    G.combo=[];renderComboTray();
    const earned=order.payout,cost=order.items.reduce((a,p)=>a+p.buy,0);
    G.cash+=earned;G.profit+=(earned-cost);G.deliveries++;G.combos++;
    delete G.orders[bid];clearBubble(bid);
    moveRider(bid);spawnCoinPop(bid,earned);
    updateHUD();renderInventory();renderCapacity();
    setStatus(`âœ“ SET delivered to ${BUILDINGS.find(b=>b.id===bid)?.name}! +$${earned} ðŸŽ`);
  }else{
    if(order.product.id!==id){setStatus(`âš  They want ${order.product.icon}! Check the bubble.`);return;}
    const inv=G.inventory.find(x=>x.id===id);if(!inv){setStatus('âš  Not in inventory!');return;}
    inv.qty--;if(inv.qty<=0)G.inventory=G.inventory.filter(x=>x.qty>0);
    const earned=order.payout;
    G.cash+=earned;G.profit+=(earned-order.product.buy);G.deliveries++;
    delete G.orders[bid];clearBubble(bid);
    moveRider(bid);spawnCoinPop(bid,earned);
    updateHUD();renderInventory();renderCapacity();
    setStatus(`âœ“ Delivered ${order.product.icon} to ${BUILDINGS.find(b=>b.id===bid)?.name}! +$${earned}`);
  }
  setTimeout(()=>{if(G.active)spawnOrders();},2500+Math.random()*3000);
  if(T.active&&TUT_STEPS[T.step]?.trigger==='delivery')advanceTut();
}

function spawnCoinPop(bid,amount){
  const bEl=document.getElementById('b-'+bid);if(!bEl)return;
  const r=bEl.getBoundingClientRect();
  const pop=document.createElement('div');pop.className='coin-pop';
  pop.style.cssText=`left:${r.left+r.width/2}px;top:${r.top+10}px;color:var(--green);`;
  pop.textContent=`+$${amount}`;document.body.appendChild(pop);setTimeout(()=>pop.remove(),900);
}
function moveRider(bid){
  const bEl=document.getElementById('b-'+bid),area=document.getElementById('mapArea');
  if(!bEl||!area)return;
  const br=bEl.getBoundingClientRect(),mr=area.getBoundingClientRect();
  const rider=document.getElementById('mapRider');
  rider.style.left=(br.left-mr.left+br.width/2-13)+'px';rider.style.top=(br.top-mr.top+br.height-13)+'px';
  const c=document.getElementById('mapCanvas');
  setTimeout(()=>{rider.style.left=(c.width*.5-13)+'px';rider.style.top=(c.height*.82-13)+'px';},1600);
}

function renderPowers(){
  const el=document.getElementById('powerButtons');el.innerHTML='';
  POWERS.forEach(pw=>{
    const isQuickBuyOwned=pw.oneTime&&pw.id==='quickBuy'&&G.upgrades.quickBuy;
    const isActive=G.activePowers[pw.id];
    const btn=document.createElement('button');
    btn.className='power-btn'+(isActive?' active-power':'');
    btn.disabled=G.cash<pw.cost||isQuickBuyOwned||isActive;
    if(isQuickBuyOwned){
      btn.innerHTML=`${pw.icon} ${pw.name}<span class="pcost" style="color:var(--green)">âœ“ ACTIVE PERM</span><span class="pdesc">${pw.desc}</span>`;
    }else{
      btn.innerHTML=`${pw.icon} ${pw.name}<span class="pcost">$${pw.cost}${pw.oneTime?' (PERM)':''}</span><span class="pdesc">${pw.desc}</span>`;
    }
    btn.addEventListener('click',()=>activatePower(pw));
    el.appendChild(btn);
  });
}
function activatePower(pw){
  if(!G.active){setStatus('âš  Round not active!');return;}
  if(G.cash<pw.cost){setStatus('âš  Not enough cash for this power!');return;}
  G.cash-=pw.cost;updateHUD();
  if(pw.id==='priceUp'){
    G.activePowers.priceUp=true;renderMarket();
    setTimeout(()=>{G.activePowers.priceUp=false;renderMarket();renderPowers();},pw.duration);
  }else if(pw.id==='moreDemand'){
    G.activePowers.moreDemand=true;spawnOrders();spawnOrders();
    setTimeout(()=>{G.activePowers.moreDemand=false;renderPowers();},pw.duration);
  }else if(pw.id==='quickBuy'){
    G.upgrades.quickBuy=true;renderShop();
  }
  const flash=document.createElement('div');flash.className='power-flash';
  flash.style.borderColor=pw.id==='priceUp'?'gold':pw.id==='moreDemand'?'#cc88ff':'var(--green)';
  document.body.appendChild(flash);setTimeout(()=>flash.remove(),400);
  setStatus(`âš¡ ${pw.name} activated!`);
  renderPowers();
}

function startTimer(){
  G.timeLeft=ROUND_TIME;clearInterval(G.timer);
  G.timer=setInterval(()=>{
    G.timeLeft=Math.max(0,G.timeLeft-.1);
    const pct=(G.timeLeft/ROUND_TIME)*100;
    const bar=document.getElementById('timerBar');
    const col=pct>50?'var(--green)':pct>20?'var(--accent)':'var(--red)';
    bar.style.width=pct+'%';bar.style.background=col;bar.style.boxShadow=`0 0 8px ${col}`;
    if(G.timeLeft<=0){clearInterval(G.timer);endRound();}
  },100);
}

function showRoundScreen(){
  const nextR=G.round+1;
  document.getElementById('rTitle').textContent=G.round===0?'GET READY!':`ROUND ${nextR} COMING UP`;
  document.getElementById('rSubtitle').textContent=G.round===0?'Wall Street is HUNGRY!':`Profit so far: $${G.profit} / Target: $${roundTarget()}`;
  const ev=EVENTS[Math.floor(Math.random()*EVENTS.length)];
  G.event=ev;initPrices(ev);
  document.getElementById('rEventText').innerHTML=ev.text.replace(/\n/g,'<br>');
  const infoBox=document.getElementById('rInfoBox'),infoEl=document.getElementById('rInfoText');
  let msg='';
  if(nextR===4)msg='ðŸ†• Customers now have <strong>timers</strong> â€” deliver before they leave! Two new buildings unlock!';
  if(nextR===5)msg='ðŸ†• Customers order <strong>SETS</strong> of food! Click items in inventory to build a set, then drag to deliver. âš¡ POWERS also now available in the market panel!';
  if(msg){infoBox.style.display='block';infoEl.innerHTML=msg;}else infoBox.style.display='none';
  document.getElementById('roundScreen').classList.add('active');
}
function roundTarget(){return BASE_TARGET+G.round*40;}

function startRound(){
  document.getElementById('roundScreen').classList.remove('active');
  G.round++;G.active=true;G.orders={};
  Object.values(G.orderTimers).forEach(t=>clearTimeout(t));G.orderTimers={};
  document.querySelectorAll('.order-bubble').forEach(b=>b.remove());
  updateHUD();renderMarket();renderShop();buildMap();spawnOrders();
  [8000,16000,28000,42000].forEach(t=>setTimeout(()=>{if(G.active)spawnOrders();},t));
  startTimer();
  let statusMsg=`Round ${G.round}/${TOTAL_ROUNDS} â€” Drag items to deliver!`;
  if(G.round>=5)statusMsg+=' Click items to BUILD SETS!';
  if(G.round>=4)statusMsg+=' Watch order timers!';
  setStatus(statusMsg);
  if(T.active&&TUT_STEPS[T.step]?.trigger==='roundStart')advanceTut();
}

function endRound(){
  G.active=false;clearInterval(G.timer);G.orders={};
  Object.values(G.orderTimers).forEach(t=>clearTimeout(t));G.orderTimers={};
  document.querySelectorAll('.order-bubble').forEach(b=>b.remove());
  if(G.round>=TOTAL_ROUNDS)setTimeout(showGameOver,600);
  else setTimeout(showRoundScreen,800);
}

function updateHUD(){
  document.getElementById('hudCash').textContent='$'+G.cash;
  const p=G.profit,el=document.getElementById('hudProfit');
  el.textContent=(p>=0?'+':'')+'$'+p;el.className='hud-value '+(p>=0?'green':'red');
  document.getElementById('hudTarget').textContent='$'+roundTarget();
  const pips=document.getElementById('roundPips');pips.innerHTML='';
  for(let i=0;i<TOTAL_ROUNDS;i++){
    const d=document.createElement('div');
    d.className='pip'+(i<G.round-1?' done':i===G.round-1?' active':'');pips.appendChild(d);
  }
  ['bike','bag','vip','intel'].forEach(k=>{
    const el=document.getElementById('u'+k);
    if(el)el.className='upg-badge'+(G.upgrades[k]?' on':'');
  });
}
function setStatus(m){document.getElementById('statusMsg').textContent=m;}

function showGameOver(){
  const target=BASE_TARGET+TOTAL_ROUNDS*40,pct=G.profit/target;
  let grade,title;
  if(pct>=1.5){grade='S+';title='ðŸ† WALL ST. LEGEND!';}
  else if(pct>=1.2){grade='S';title='ðŸ’° CRUSHING IT!';}
  else if(pct>=1.0){grade='A';title='âœ… TARGET HIT!';}
  else if(pct>=.75){grade='B';title='ðŸ“ˆ SO CLOSE!';}
  else if(pct>=.50){grade='C';title='ðŸš² KEEP HUSTLING!';}
  else{grade='D';title='ðŸ˜” GAME OVER';}
  document.getElementById('goTitle').textContent=title;
  document.getElementById('goGrade').textContent=grade;
  document.getElementById('goProfit').textContent='$'+G.profit;
  document.getElementById('goTarget').textContent='$'+target;
  document.getElementById('goDeliveries').textContent=G.deliveries+(G.combos>0?` (${G.combos} set combos!)`:'');
  G.upgradePoints=Math.floor(Math.max(0,G.profit)*.35);
  renderUpgrades();
  document.getElementById('gameoverScreen').classList.add('active');
}
function renderUpgrades(){
  const el=document.getElementById('upgradesList');el.innerHTML='';
  const pts=document.createElement('div');
  pts.style.cssText='font-family:"VT323",monospace;font-size:18px;color:var(--accent);text-align:center;margin-bottom:8px;';
  pts.textContent=`UPGRADE POINTS: $${G.upgradePoints}`;el.appendChild(pts);
  UPGRADES_DEF.forEach(u=>{
    const owned=typeof G.upgrades[u.key]==='boolean'?(G.upgrades[u.key]?1:0):G.upgrades[u.key];
    const maxed=owned>=u.max,cost=u.cost[owned]??u.cost[u.cost.length-1];
    const row=document.createElement('div');row.className='upgrade-row';
    row.innerHTML=`<div class="upgrade-info">${u.icon} ${u.name}<small>${u.desc}</small></div>
      ${maxed?`<span class="upgrade-owned">â˜… MAX</span>`:`<button class="upgrade-buy" data-k="${u.key}" data-c="${cost}" ${G.upgradePoints<cost?'disabled':''}>$${cost}</button>`}`;
    el.appendChild(row);
  });
  el.querySelectorAll('.upgrade-buy:not(:disabled)').forEach(btn=>{
    btn.addEventListener('click',()=>{
      const k=btn.dataset.k,c=+btn.dataset.c;if(G.upgradePoints<c)return;
      G.upgradePoints-=c;
      if(typeof G.upgrades[k]==='boolean')G.upgrades[k]=true;else G.upgrades[k]++;
      renderUpgrades();
    });
  });
}

/* TUTORIAL */
const TUT_STEPS=[
  {id:'welcome',
   msg:'Welcome to <strong>DIHLICKVERY!</strong> You are a delivery rider on Wall Street. Buy food cheap, deliver it for profit! You have <strong>5 rounds, 60 seconds each</strong>. Beat the target to win!',
   action:'Click START ROUND to begin!',trigger:'roundStart',highlight:null},
  {id:'market',
   msg:'<strong>ðŸ“ˆ MARKET</strong> (right panel): shows each item\'s buy cost and sell price. <em>Buy low â†’ sell high = profit!</em> Prices shift every round based on events.',
   action:'Look at the market prices â€” then check the shop on the left.',trigger:'timed',triggerMs:4500,highlight:'marketPanel'},
  {id:'shop',
   msg:'<strong>ðŸª SHOP</strong> (left panel): click <em>BUY</em> on any item to add it to your bag. You start with <strong>$60</strong>. Buy the item with the biggest profit margin!',
   action:'Buy any item from the SHOP now!',trigger:'buy',highlight:'shopPanel'},
  {id:'inventory',
   msg:'Item added to your <strong>ðŸ“¦ Inventory</strong>! The blue dots at the bottom right show your bag capacity. You can hold multiple items and buy more before delivering.',
   action:'Now find a building on the map with a speech bubble showing an order!',trigger:'timed',triggerMs:3500,highlight:'inventorySlots'},
  {id:'map',
   msg:'Buildings on the <strong>map</strong> show speech bubbles with what they want and how much they pay. <strong>Drag an item</strong> from your inventory and <em>drop it onto a building</em> that wants it!',
   action:'DRAG an item from your inventory â†’ DROP it onto a matching building!',trigger:'delivery',highlight:'mapArea'},
  {id:'delivered',
   msg:'<strong>ðŸŽ‰ Delivered!</strong> Your cash and profit went up! Watch the <strong>round timer</strong> in the HUD â€” keep buying and delivering until time runs out.',
   action:'Keep delivering to earn more! Try to hit the target.',trigger:'timed',triggerMs:3500,highlight:'hudArea'},
  {id:'round4',
   msg:'<strong>Round 4 unlocks:</strong> Customers get <em>impatient!</em> A timer bar appears under each order bubble. <strong>Deliver before it empties</strong> or they leave. Two new buildings also unlock!',
   action:'Good to know! Keep delivering.',trigger:'timed',triggerMs:5000,highlight:null},
  {id:'round5sets',
   msg:'<strong>Round 5 unlocks SET orders!</strong> Customers want combos like ðŸ•+ðŸ¥¤+ðŸ—. <em>Click items in your inventory</em> to build the set in the SET tray, then <strong>drag any item</strong> to the building to deliver the set.',
   action:'Almost done! One more thing...',trigger:'timed',triggerMs:5000,highlight:'comboTray'},
  {id:'powers',
   msg:'<strong>âš¡ POWERS</strong> appear in the market panel from Round 3. Spend cash to activate: <em>Price Boost</em> (+50% sell), <em>More Demand</em> (extra orders), or buy <em>Quick Buy</em> (click items = instant buy, permanent!)',
   action:'You\'re ready! Now you try it yourself! ðŸ›µðŸ’¨',trigger:'click',highlight:'powerPanel',final:true},
];

let T={active:false,step:0,timer:null};

function startTutorial(){
  T.active=true;T.step=0;
  const savedUpg=G.upgrades;
  resetGame();G.upgrades=savedUpg;G.tutMode=true;
  showScreen('gameScreen');
  document.getElementById('tutorialBadge').classList.add('show');
  buildMap();showRoundScreen();
  setTimeout(()=>showTutStep(0),200);
}

function showTutStep(idx){
  if(idx>=TUT_STEPS.length){endTutorial();return;}
  T.step=idx;
  const step=TUT_STEPS[idx];
  const bar=document.getElementById('tutBar');bar.classList.add('show');
  document.getElementById('tutBarStep').textContent=`STEP ${idx+1}/${TUT_STEPS.length}`;
  let html=step.msg;
  if(step.action)html+=` <em>â–¶ ${step.action}</em>`;
  document.getElementById('tutBarMsg').innerHTML=html;
  const dots=document.getElementById('tutBarDots');dots.innerHTML='';
  TUT_STEPS.forEach((_,i)=>{
    const d=document.createElement('div');
    d.className='tut-dot'+(i<idx?' done':i===idx?' cur':'');dots.appendChild(d);
  });
  clearTutHighlight();
  if(step.highlight){
    const el=document.getElementById(step.highlight)||document.querySelector('.'+step.highlight);
    if(el)el.classList.add('tut-highlight');
  }
  clearTimeout(T.timer);
  if(step.trigger==='timed'){T.timer=setTimeout(()=>advanceTut(),step.triggerMs);}
  else if(step.trigger==='click'||step.final){
    bar.style.cursor='pointer';bar.style.pointerEvents='all';
    bar.onclick=()=>{bar.onclick=null;bar.style.cursor='';bar.style.pointerEvents='none';advanceTut();};
  }else{bar.onclick=null;bar.style.cursor='default';bar.style.pointerEvents='none';}
}
function clearTutHighlight(){document.querySelectorAll('.tut-highlight').forEach(el=>el.classList.remove('tut-highlight'));}
function advanceTut(){clearTimeout(T.timer);showTutStep(T.step+1);}
function endTutorial(){
  T.active=false;
  const bar=document.getElementById('tutBar');bar.classList.remove('show');bar.onclick=null;bar.style.pointerEvents='none';
  clearTutHighlight();
  document.getElementById('tutorialBadge').classList.remove('show');
  G.tutMode=false;
}

function startGame(){
  const savedUpg=G.upgrades;resetGame();G.upgrades=savedUpg;
  showScreen('gameScreen');buildMap();showRoundScreen();
}

document.getElementById('btnPlay').addEventListener('click',startGame);
document.getElementById('btnTutorial').addEventListener('click',startTutorial);
document.getElementById('btnCredits').addEventListener('click',()=>document.getElementById('creditsModal').classList.add('active'));
document.getElementById('closeCredits').addEventListener('click',()=>document.getElementById('creditsModal').classList.remove('active'));
document.getElementById('creditsModal').addEventListener('click',(e)=>{if(e.target===document.getElementById('creditsModal'))document.getElementById('creditsModal').classList.remove('active');});
document.getElementById('honorBtn').addEventListener('click',(e)=>{e.stopPropagation();document.getElementById('honorBubble').classList.toggle('show');});
document.getElementById('btnSandbox').addEventListener('click',()=>{const b=document.getElementById('btnSandbox');b.style.transform='rotate(-3deg)';setTimeout(()=>{b.style.transform='rotate(3deg)';setTimeout(()=>{b.style.transform='';},100);},100);});
document.getElementById('roundStartBtn').addEventListener('click',startRound);
document.getElementById('btnPause').addEventListener('click',()=>{clearInterval(G.timer);Object.values(G.orderTimers).forEach(t=>clearTimeout(t));G.active=false;showScreen('menuScreen');});
document.getElementById('goRetry').addEventListener('click',()=>{document.getElementById('gameoverScreen').classList.remove('active');startGame();});
document.getElementById('goMenu').addEventListener('click',()=>{document.getElementById('gameoverScreen').classList.remove('active');showScreen('menuScreen');});
window.addEventListener('resize',()=>{if(document.getElementById('gameScreen').classList.contains('active'))buildMap();});
</script>
</body>
</html>
